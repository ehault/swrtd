<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Summoner War: Rush TD — Character Guide</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Inline SVG favicon: round split EHA/ULT for readability -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='%23ded8ff'/><stop offset='1' stop-color='%23b8a6ff'/></linearGradient></defs><circle cx='64' cy='64' r='62' fill='url(%23g)' stroke='%23d7caff' stroke-width='4'/><line x1='20' y1='64' x2='108' y2='64' stroke='rgba(31,36,67,0.18)' stroke-width='1'/><text x='64' y='50' text-anchor='middle' font-family='Inter, Arial, sans-serif' font-size='40' font-weight='900' fill='%231f2443' stroke='%23f0f3ff' stroke-width='2' stroke-opacity='0.55' paint-order='stroke fill' letter-spacing='2'>EHA</text><text x='64' y='94' text-anchor='middle' font-family='Inter, Arial, sans-serif' font-size='40' font-weight='900' fill='%231f2443' stroke='%23f0f3ff' stroke-width='2' stroke-opacity='0.55' paint-order='stroke fill' letter-spacing='2'>ULT</text></svg>">
  <style>
    :root {
      --bg-grad-a: #1f2443;
      --bg-grad-b: #2e1348;
      --card: #0f1224;
      --muted: #9aa0b7;
      --text: #e8ebff;
      --accent: #7c5cff;
      --accent-2: #5bd6ff;
      --success: #38d39f;
      --warning: #ffc857;
      --danger: #ff7b7b;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
  /* Ensure background spans beyond the viewport when content is taller */
  html, body { min-height: 100%; }
    body {
      margin: 0; color: var(--text); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% -20%, rgba(124,92,255,.25), transparent),
                  radial-gradient(1000px 700px at 90% -10%, rgba(91,214,255,.18), transparent),
                  linear-gradient(145deg, var(--bg-grad-a), var(--bg-grad-b));
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

    header { text-align: center; margin: 12px 0 24px; }
    header h1 { margin: 0; font-size: clamp(24px, 4vw, 36px); font-weight: 700; letter-spacing: 0.2px; }
    header p { margin: 6px 0 0; color: var(--muted); }

    .tabs { display: flex; gap: 10px; justify-content: center; margin: 24px 0; flex-wrap: wrap; }
    .tab-btn {
      background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(255,255,255,.08);
      padding: 10px 16px; border-radius: 999px; cursor: pointer; font-weight: 600; transition: .2s ease;
      backdrop-filter: blur(6px);
    }
    .tab-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .tab-btn.active { background: var(--accent); border-color: transparent; box-shadow: 0 8px 22px rgba(124,92,255,.35); }

  /* Tier list */
  .tier-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
  .tier-row { display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; }
  .tier-title { display: inline-flex; align-items: center; justify-content: center; font-weight: 900; letter-spacing: .4px; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); }
  .tier-items { display: flex; flex-wrap: wrap; gap: 8px; }
  .char-chip { appearance: none; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--text); padding: 6px 10px; border-radius: 999px; font-weight: 700; cursor: pointer; transition: .15s ease; }
  .char-chip:hover { transform: translateY(-1px); background: rgba(255,255,255,.1); }
  /* Class-colored character chips (inherit class chip gradients) */
  .char-chip.cls-melee, .char-chip.cls-ranged, .char-chip.cls-utility, .char-chip.cls-tank {
    border-color: rgba(255,255,255,0.08);
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.10);
  }
  .char-chip.cls-melee:hover, .char-chip.cls-ranged:hover, .char-chip.cls-utility:hover, .char-chip.cls-tank:hover {
    filter: brightness(1.05);
  }
  /* Tier coloring: S→C/Untiered = green→red/black */
  .tier-row { border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 8px; background: rgba(255,255,255,.03); }
  .tier-row.tier-S { border-left: 6px solid #34d399; }
  .tier-row.tier-A { border-left: 6px solid #a3e635; }
  .tier-row.tier-B { border-left: 6px solid #f59e0b; }
  .tier-row.tier-C { border-left: 6px solid #ef4444; }
  .tier-row.tier-Untiered { border-left: 6px solid #0f172a; }
  .tier-row.tier-S .tier-title { background: rgba(52,211,153,.18); border-color: rgba(52,211,153,.38); color: #d6fff0; }
  .tier-row.tier-A .tier-title { background: rgba(163,230,53,.18); border-color: rgba(163,230,53,.38); color: #f2ffd6; }
  .tier-row.tier-B .tier-title { background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.38); color: #fff1db; }
  .tier-row.tier-C .tier-title { background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.38); color: #ffe3e3; }
  .tier-row.tier-Untiered .tier-title { background: rgba(15,23,42,.5); border-color: rgba(15,23,42,.8); color: #e2e8f0; }

    .panel { display: none; }
    .panel.active { display: block; }

  .toolbar { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 12px 0 24px; align-items: start; }
    .toolbar .filters { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; align-items: start; }
    .filter-group.filter-keywords { grid-column: 1 / -1; }
  .search-col { display: flex; flex-direction: column; gap: 8px; }

    .input, .select {
      width: 100%; max-width: 600px; background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(255,255,255,.10);
      padding: 12px 14px; border-radius: 10px; outline: none; transition: .2s ease; min-width: 260px;
    }
    .input::placeholder { color: #9aa0b7; }
    .input:focus, .select:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(91,214,255,.12); }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

        .card { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border: 1px solid rgba(255,255,255,.08);
          border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); position: relative; overflow: hidden;
          display: flex; flex-direction: column; }
    .card .badge { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; letter-spacing: .3px; border: 1px solid rgba(255,255,255,.14); box-shadow: 0 4px 12px rgba(0,0,0,.25); }
    .modal-header .badge { padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; letter-spacing: .3px; border: 1px solid rgba(255,255,255,.14); box-shadow: 0 4px 12px rgba(0,0,0,.25); }
    .incomplete { font-size: 11px; color: #ffd1d6; background: rgba(220,38,38,.16); border: 1px solid rgba(220,38,38,.55); padding: 6px 8px; border-radius: 8px; margin-top: 10px; }
    .card-actions { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-top: auto; padding-top: 12px; }
    .card-actions .incomplete { margin: 0; font-size: 11px; padding: 4px 6px; }

  .cls-melee { background: linear-gradient(90deg, #ff5757, #ff9966); color: #1a0d12; }
  .cls-ranged { background: linear-gradient(90deg, #57a2ff, #6be1ff); color: #07121e; }
  .cls-utility { background: linear-gradient(90deg, #57ffb0, #7dff9a); color: #07140f; }
  .cls-tank { background: linear-gradient(90deg, #fff099, #ffe070); color: #262006; }

  /* Make class chips slightly rectangular instead of fully pill-shaped */
  .kw.cls-melee, .kw.cls-ranged, .kw.cls-utility, .kw.cls-tank { border-radius: 10px; padding: 6px 10px; border: 1px solid rgba(255,255,255,.14); }

    .card h3 { margin: 0 0 4px; font-size: 18px; }
    .statline { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 6px 0; }
    .stat { background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.06); border-radius: 8px; text-align: center; padding: 4px 6px; }
    .stat .lab { display: block; font-size: 11px; color: var(--muted); }
    .stat .val { display: block; font-weight: 700; font-size: 15px; margin-top: 2px; }
    .release { font-size: 10px; color: var(--muted); margin: 0 0 0; }

    .keywords { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  /* Category keyword row spacing (e.g., BUFF/DEBUFF) */
  .keywords.kw-cats { margin-bottom: 6px; }
    .kw { font-size: 11px; font-weight: 700; letter-spacing: .3px; padding: 5px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); }
    .kw.buff { background: rgba(56,211,159,.18); border-color: rgba(56,211,159,.35); color: #b8ffe6; }
    .kw.debuff { background: rgba(255,123,123,.18); border-color: rgba(255,123,123,.35); color: #ffd6d6; }
    .kw.crit-rate-up { background: rgba(124,92,255,.18); border-color: rgba(124,92,255,.38); color: #e3d9ff; }
    .kw.crush-rate-up { background: rgba(91,214,255,.18); border-color: rgba(91,214,255,.38); color: #daf6ff; }
    .kw.crit-dmg-up { background: rgba(255,200,87,.18); border-color: rgba(255,200,87,.38); color: #fff0c2; }
  /* Additional keyword chip styles for consistent distinct colors */
  .kw.crush-dmg-up { background: rgba(255,145,0,.18); border-color: rgba(255,145,0,.38); color: #ffe2c4; }
  .kw.stacked-shield { background: rgba(72,201,176,.18); border-color: rgba(72,201,176,.38); color: #d7fff4; }
  .kw.dmg-res-up { background: rgba(76,111,255,.18); border-color: rgba(76,111,255,.38); color: #dbe2ff; }
  .kw.dmg-res-down { background: rgba(255,120,120,.18); border-color: rgba(255,120,120,.38); color: #ffe0e0; }
  .kw.gigantify { background: rgba(255,159,67,.18); border-color: rgba(255,159,67,.38); color: #fff0dc; }
  .kw.crit-resistance-up { background: rgba(107,200,255,.18); border-color: rgba(107,200,255,.38); color: #e6f6ff; }
  .kw.crit-damage-down { background: rgba(255,102,196,.18); border-color: rgba(255,102,196,.38); color: #ffe4f2; }
  .kw.incoming-crit-dmg-up { background: rgba(255,94,122,.18); border-color: rgba(255,94,122,.38); color: #ffe0e6; }
  .kw.atk-up { background: rgba(255,179,102,.18); border-color: rgba(255,179,102,.38); color: #fff0e2; }
  .kw.add-dmg { background: rgba(187,134,252,.18); border-color: rgba(187,134,252,.38); color: #efe6ff; }
  .kw.atk-spd-down { background: rgba(114,137,218,.18); border-color: rgba(114,137,218,.38); color: #e6ebff; }
  .kw.incoming-aoe-dmg-up { background: rgba(255,127,80,.18); border-color: rgba(255,127,80,.38); color: #ffe9e2; }
  .kw.incoming-aoe-dmg-down { background: rgba(80,200,140,.18); border-color: rgba(80,200,140,.38); color: #e6fff3; }
  .kw.crit-dmg-taken-up { background: rgba(240,80,160,.18); border-color: rgba(240,80,160,.38); color: #ffe1ef; }
  .kw.over-crit { background: rgba(160,120,255,.18); border-color: rgba(160,120,255,.38); color: #ede6ff; }
  .kw.over-crush { background: rgba(80,220,200,.18); border-color: rgba(80,220,200,.38); color: #e6fff9; }
  /* New kit/general chips */
  .kw.dmg-dealt-up { background: rgba(0,200,160,.18); border-color: rgba(0,200,160,.38); color: #d8fff4; }
  .kw.double-hit-rate-up { background: rgba(90,200,90,.18); border-color: rgba(90,200,90,.38); color: #eaffea; }
  .kw.range-up { background: rgba(180,220,90,.18); border-color: rgba(180,220,90,.38); color: #f6ffe0; }
  .kw.atk-spd-up { background: rgba(80,230,180,.18); border-color: rgba(80,230,180,.38); color: #e6fff6; }
  .kw.triple-hit-rate-up { background: rgba(190,120,255,.18); border-color: rgba(190,120,255,.38); color: #f3e8ff; }
  .kw.devilmons { background: rgba(255,105,180,.18); border-color: rgba(255,105,180,.38); color: #ffe3f1; }
  .kw.mov-spd-up { background: rgba(255,210,100,.18); border-color: rgba(255,210,100,.38); color: #fff3d6; }
  .kw.def-up { background: rgba(130,180,255,.18); border-color: rgba(130,180,255,.38); color: #e8f2ff; }
  .kw.invincibility { background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.45); color: #ffffff; }
  .kw.dmg-down-from-ranged-enemies { background: rgba(255,150,150,.18); border-color: rgba(255,150,150,.38); color: #ffe6e6; }
  /* Generic fallback chip color */
  .kw.generic { background: rgba(200,200,255,.14); border-color: rgba(200,200,255,.28); color: #eef0ff; }
  /* Additional commonly used keyword colors */
  .kw.aoe-dmg-up { background: rgba(255,170,60,.18); border-color: rgba(255,170,60,.38); color: #fff0dc; }
  .kw.acc-up { background: rgba(120,200,255,.18); border-color: rgba(120,200,255,.38); color: #e6f6ff; }
  .kw.def-down { background: rgba(255,120,120,.18); border-color: rgba(255,120,120,.38); color: #ffe0e0; }
  .kw.mov-spd-down { background: rgba(255,180,120,.18); border-color: rgba(255,180,120,.38); color: #fff0e4; }
  .kw.cdr-up { background: rgba(140,220,255,.18); border-color: rgba(140,220,255,.38); color: #e8fbff; }
  .kw.root { background: rgba(170,255,150,.18); border-color: rgba(170,255,150,.38); color: #efffee; }
  .kw.blind { background: rgba(150,130,255,.18); border-color: rgba(150,130,255,.38); color: #ece6ff; }
  .kw.stealth { background: rgba(120,120,120,.24); border-color: rgba(180,180,180,.28); color: #f0f0f0; }
  .kw.dampen { background: rgba(255,140,160,.18); border-color: rgba(255,140,160,.38); color: #ffe6eb; }
  .kw.amplify { background: rgba(255,220,100,.18); border-color: rgba(255,220,100,.38); color: #fff6d6; }
  .kw.frostbite { background: rgba(160,210,255,.18); border-color: rgba(160,210,255,.38); color: #eaf6ff; }
  .kw.bleed { background: rgba(255,100,120,.18); border-color: rgba(255,100,120,.38); color: #ffe4e8; }
  .kw.burn { background: rgba(255,120,80,.18); border-color: rgba(255,120,80,.38); color: #ffe6dc; }
  .kw.venom { background: rgba(120,220,140,.18); border-color: rgba(120,220,140,.38); color: #eafff0; }
  .kw.fear { background: rgba(255,100,200,.18); border-color: rgba(255,100,200,.38); color: #ffe6f7; }
  .kw.remove-immunity { background: rgba(255,240,120,.18); border-color: rgba(255,240,120,.38); color: #fffbe0; }
  .kw.crit-rate-down { background: rgba(160,120,255,.18); border-color: rgba(160,120,255,.38); color: #eee6ff; }
  .kw.basic-attack { background: rgba(120,255,200,.18); border-color: rgba(120,255,200,.38); color: #eafff7; }
  .kw.crit-attack { background: rgba(255,200,140,.18); border-color: rgba(255,200,140,.38); color: #fff3e1; }
  .kw.ultimate { background: rgba(255,160,220,.18); border-color: rgba(255,160,220,.38); color: #ffe6f5; }

  /* Keyword micro-badges for applicability and stackability */
  .kw .mini { display:inline-block; font-size:10px; font-weight:700; letter-spacing:.2px; padding:2px 6px; border-radius:999px; margin-left:6px; border:1px solid rgba(255,255,255,.18); }
  .mini.all { border-color: rgba(91,214,255,.45); color:#daf6ff; }
  /* Match target mini badges to class chip colors for consistency */
  .mini.melee { background: linear-gradient(90deg, #ff5757, #ff9966); color:#1a0d12; border-color: transparent; }
  .mini.ranged { background: linear-gradient(90deg, #57a2ff, #6be1ff); color:#07121e; border-color: transparent; }
  .mini.utility { background: linear-gradient(90deg, #57ffb0, #7dff9a); color:#07140f; border-color: transparent; }
  .mini.tank { background: linear-gradient(90deg, #fff099, #ffe070); color:#262006; border-color: transparent; }
  .mini.stack { border-color: rgba(56,211,159,.45); color:#b8ffe6; }
  .mini.irrem { border-color: rgba(124,92,255,.55); color:#e3d9ff; }

  /* Class radio chip group */
  .class-boxes { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; width: 100%; max-width: none; }
  .cls-radio { display: none; }
  .cls-radio:checked + .kw-label .kw { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(91,214,255,.18); }
  /* Filter group wrappers */
  .filter-group { display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 12px; }
  .filter-group .group-row { display: flex; align-items: center; gap: 12px; }
  .filter-group .group-row #hide-self-btn { margin-left: auto; }
  .filter-group .group-row .toggle-btn { padding: 6px 10px; }
  .group-title { font-size: 12px; font-weight: 800; letter-spacing: .3px; color: #cfd5ff; text-transform: uppercase; }
  .group-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }

    /* Toggle button for options */
    .toggle-btn {
      background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(255,255,255,.12);
      padding: 8px 12px; border-radius: 999px; cursor: pointer; font-weight: 700; transition: .2s ease;
    }
    .toggle-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .toggle-btn.active { border-color: var(--accent-2); box-shadow: 0 0 0 3px rgba(91,214,255,.14); }

    .btn {
      appearance: none; border: none; background: var(--accent); color: white; font-weight: 700; padding: 10px 14px;
      border-radius: 10px; cursor: pointer; transition: .2s ease; box-shadow: 0 8px 22px rgba(124,92,255,.35);
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

    dialog { width: min(900px, 92vw); border: 1px solid rgba(255,255,255,.15); border-radius: 16px; background: linear-gradient(180deg, rgba(20,22,40,.98), rgba(10,12,24,.98)); color: var(--text); box-shadow: var(--shadow); }
    dialog::backdrop { background: rgba(0,0,0,.55); backdrop-filter: blur(2px); }
    .modal-header { display: flex; gap: 10px; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,.08); padding: 14px 16px; }
    .modal-title { display: flex; align-items: center; gap: 10px; }
    .close-x { background: transparent; border: 1px solid rgba(255,255,255,.18); color: var(--text); padding: 6px 10px; border-radius: 10px; cursor: pointer; }
    .modal-body { padding: 16px; }
    .two-col { display: grid; grid-template-columns: 1.1fr .9fr; gap: 16px; }
    .two-subcol { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .section { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 14px; }
    .section h4 { margin: 0 0 10px; font-size: 15px; letter-spacing: .3px; color: #cfd5ff; }
    .ability { margin-bottom: 12px; }
    .ability .name { font-weight: 700; }
    .ability .type { font-size: 12px; color: var(--muted); }
  .ability-description { white-space: pre-line; }
  .ability-meta { font-size: 12px; color: var(--muted); margin: 4px 0 6px; }
  .awk-name { font-weight: 700; font-size: 12px; }
  .awk-desc { font-size: 12px; color: var(--muted); margin: 2px 0 6px; white-space: pre-line; }
    .notes { font-size: 13px; color: #d4bfff; background: rgba(124,92,255,.12); border: 1px solid rgba(124,92,255,.25); padding: 10px; border-radius: 8px; white-space: pre-line; }
  /* General advice tweaks: allow normal wrapping and better chip alignment */
  #general-content { white-space: normal; line-height: 1.5; }
  #general-content .kw { display: inline-flex; align-items: center; vertical-align: baseline; margin: 0 2px; padding: 3px 6px; }
  /* General chips */
  .kw.crystals { background: rgba(91,214,255,.18); border-color: rgba(91,214,255,.38); color: #daf6ff; }
  .kw.stars { background: rgba(255,200,87,.18); border-color: rgba(255,200,87,.38); color: #fff0c2; }
  .kw.awakening { background: rgba(187,134,252,.18); border-color: rgba(187,134,252,.38); color: #efe6ff; }
  .kw.breakthrough-stones { background: rgba(255,180,80,.18); border-color: rgba(255,180,80,.38); color: #fff1dc; }
  .kw.magic-orbs { background: rgba(120,255,220,.18); border-color: rgba(120,255,220,.38); color: #e9fff8; }
  .kw.attack-speed { background: rgba(80,230,180,.18); border-color: rgba(80,230,180,.38); color: #e6fff6; }
  /* Awakening level chips: green (A3) → orange (A5) → red (A7) */
  .kw.awk-l3 { background: rgba(80,230,180,.18); border-color: rgba(80,230,180,.38); color: #e6fff6; }
  .kw.awk-l5 { background: rgba(255,180,80,.18); border-color: rgba(255,180,80,.38); color: #fff1dc; }
  .kw.awk-l7 { background: rgba(255,100,120,.18); border-color: rgba(255,100,120,.38); color: #ffe4e8; }

    .lexicon { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
    .lex-item { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-left: 4px solid var(--accent-2); padding: 12px; border-radius: 10px; }
    .lex-term { font-weight: 800; letter-spacing: .4px; margin-bottom: 6px; }
  .lex-desc { color: var(--muted); font-size: 14px; white-space: pre-line; line-height: 1.75; }
  /* Ensure chips inside lexicon descriptions don’t overlap and align nicely */
  .lex-desc .kw { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 2px; padding: 2px 6px; line-height: 1.1; }

  /* Keyword tooltip */
  .kw-tooltip { position: fixed; z-index: 10000; max-width: 340px; padding: 10px 12px; border-radius: 10px;
    background: linear-gradient(180deg, rgba(20,22,40,.98), rgba(10,12,24,.98)); border: 1px solid rgba(255,255,255,.14);
    box-shadow: 0 12px 30px rgba(0,0,0,.45); color: var(--text); pointer-events: none; opacity: 0; transform: translateY(4px);
    transition: opacity .12s ease, transform .12s ease; }
  .kw-tooltip.show { opacity: 1; transform: translateY(0); }
  .kw-tooltip .tt-term { font-weight: 800; margin: 0 0 6px; letter-spacing: .3px; }
  .kw-tooltip .tt-desc { font-size: 13px; color: var(--muted); white-space: pre-line; }

    footer { margin: 28px 0 8px; text-align: center; color: var(--muted); font-size: 12px; }

    /* Keyword checkbox group */
  .kw-boxes { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start; width: 100%; max-width: none; max-height: 220px; overflow-y: auto; padding: 8px; }
    .kw-check { display: none; }
    /* Awakening checkbox group */
    .awk-boxes { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start; width: 100%; max-width: none; padding: 0; }
    .awk-check { display: none; }
    .awk-check:checked + .kw-label .kw { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(91,214,255,.18); }
  .kw-label { display: inline-flex; align-items: center; gap: 0; padding: 0; border: none; font-size: 11px; font-weight: 700; cursor: pointer; background: transparent; }
  .kw-check:checked + .kw-label .kw { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(91,214,255,.18); }
  /* Category chips (BUFF/DEBUFF) should sit next to each other on one line at the top */
  .kw-boxes .kw-label.kw-cat { flex: 0 0 auto; }
  /* Force a new row after category chips so other keywords start on the next line */
  .kw-boxes .kw-sep { flex: 0 0 100%; height: 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Summoner War: Rush TD — Character Guide</h1>
      <p>Compact reference for units, level 85 stats, kits, awakenings, and keyword lexicon.</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-general">General</button>
      <button class="tab-btn" data-tab="tab-characters">Characters</button>
      <button class="tab-btn" data-tab="tab-tiers">Tier List</button>
      <button class="tab-btn" data-tab="tab-lexicon">Lexicon</button>
    </div>

    

  <section id="tab-characters" class="panel">
      <div class="toolbar">
        <div class="search-col">
          <input id="search" class="input" placeholder="Search characters by name, class, or keyword…" />
          <button id="reset-all" class="toggle-btn" title="Clear all filters and state">Reset</button>
        </div>
        <div class="filters">
          <div class="filter-group filter-class">
            <div class="group-title">Class</div>
            <div id="class-boxes" class="class-boxes"></div>
          </div>
          <div class="filter-group filter-awakening">
            <div class="group-title">Awakening</div>
            <div id="awakening-boxes" class="awk-boxes"></div>
          </div>
          <div class="filter-group filter-keywords">
            <div class="group-row">
              <div class="group-title">Keywords</div>
              <button id="hide-self-btn" class="toggle-btn" aria-pressed="false" title="Hide self-only effects when filtering and on cards">Hide self-only</button>
              <button id="stack-only-btn" class="toggle-btn" aria-pressed="false" title="Only show stackable effects in filters and on cards">Stackable only</button>
            </div>
            <div id="keyword-boxes" class="kw-boxes"></div>
          </div>
        </div>
      </div>

      <div id="cards" class="grid"></div>
    </section>

    <section id="tab-tiers" class="panel">
        <div id="tier-disclaimer" class="notes" style="margin:8px 0 10px 0;">
          Disclaimer: This tier list is not a pull recommendation. It is a relative comparison assuming units are at roughly the same investment and have their recommended awakenings enabled.
        </div>
      <div class="section">
        <h4>Tier List</h4>
        <div id="tier-grid" class="tier-grid"></div>
      </div>
    </section>

    <section id="tab-lexicon" class="panel">
      <div class="toolbar">
        <input id="lex-search" class="input" placeholder="Search lexicon by name or description…" />
      </div>
      <div id="lexicon" class="lexicon"></div>
    </section>

    <section id="tab-general" class="panel active">
      <div class="section">
        <h4>General Advice</h4>
        <div id="general-content" class="notes">
          <p><strong>Progression:</strong> Prioritize raising <span class="kw stars" data-kw="stars">Stars</span> to 7★ to unlock powerful <span class="kw awakening" data-kw="awakening">Awakening</span> effects and significant stat gains along the way.</p>
          <p><strong>Resources:</strong> Use <span class="kw crystals" data-kw="crystals">Crystals</span> for summons and collect <span class="kw devilmons" data-kw="devilmons">Devilmons</span> from shops and events to trigger awakenings and complete kits.</p>
          <p><strong>Shops:</strong> There are <strong>4 shops</strong> total: <strong>3</strong> in Arena and <strong>1</strong> in <em>Sky Island Defense</em> under <em>Sky Patrol</em>. Purchase priority: <span class="kw devilmons" data-kw="devilmons">Devilmons</span>, <span class="kw breakthrough-stones" data-kw="breakthrough stones">Breakthrough Stones</span>, <span class="kw magic-orbs" data-kw="magic orbs">Magic Orbs</span>.</p>
          <p><strong>Gear:</strong> Gear uses <span class="kw magic-orbs" data-kw="magic orbs">Magic Orbs</span> to pull new pieces. Prioritize <span class="kw crit-rate-up" data-kw="crit rate up">CRIT Rate UP</span>, <span class="kw crit-dmg-up" data-kw="crit dmg up">CRIT DMG UP</span>, and <span class="kw crush-rate-up" data-kw="crush rate up">Crush Rate UP</span> unless you have a specific build in mind.</p>
          <p><strong>Pull Plan:</strong> Larger batches of pulls provide better outcomes over time (e.g., 10 pulls = 3,000 <span class="kw crystals" data-kw="crystals">Crystals</span>). For mass summon rewards, pull <strong>19,000</strong> in a single batch (~2M <span class="kw crystals" data-kw="crystals">Crystals</span>) — these rewards do <em>not</em> roll over to later banners. Aim to secure enough <span class="kw devilmons" data-kw="devilmons">Devilmons</span> and stars for your target unit’s full awakening path.</p>
        </div>
      </div>
    </section>

    <dialog id="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span id="modal-badge" class="badge cls-melee">MELEE</span>
          <h3 id="modal-title">Character</h3>
        </div>
        <button id="modal-close" class="close-x">Close</button>
      </div>
      <div class="modal-body">
        <div class="two-col">
          <div class="section">
            <h4>Level 85 Stats</h4>
            <div id="m-stats" class="statline"></div>
            <div><span class="lab">Keywords</span><div id="m-kws" class="keywords" style="margin-top:6px"></div></div>
          </div>
          <div class="section">
            <h4>Recommendations</h4>
            <div id="m-reco" class="notes">—</div>
            <h4 style="margin-top: 12px;">Notes</h4>
            <div id="m-notes" class="notes">—</div>
            <div id="m-incomplete" class="incomplete" style="display:none">Kit info incomplete: missing awakening and/or notes.</div>
          </div>
        </div>
        <div class="section" style="margin-top:14px">
          <h4>Kit</h4>
          <div class="ability"><div class="name">Basic</div><div id="m-basic" class="ability-description">—</div><div id="m-basic-meta" class="ability-meta"></div><div id="m-basic-kws" class="ability-keywords keywords"></div></div>
          <div class="ability"><div class="name">Crit Attack</div><div id="m-crit" class="ability-description">—</div><div id="m-crit-meta" class="ability-meta"></div><div id="m-crit-kws" class="ability-keywords keywords"></div></div>
          <div class="ability"><div class="name">Ultimate</div><div id="m-ult" class="ability-description">—</div><div id="m-ult-meta" class="ability-meta"></div><div id="m-ult-kws" class="ability-keywords keywords"></div></div>
        </div>
        <div class="section" style="margin-top:14px">
          <h4>Awakening Effects</h4>
          <ol id="m-awks" style="padding-left:18px; margin:0"></ol>
        </div>
      </div>
    </dialog>

    <footer>
      Data here is seed/placeholder for Summoner War: Rush TD. Verify values in-game. Keywords are described in Lexicon.
    </footer>
  </div>

  <script>
    // Seed keywords/lexicon. Keep to terms provided + common TD notions; avoid other games.
    const LEXICON = {
      'buff': {
        name: 'Buff',
        desc: 'A positive effect that enhances allied stats or behavior for a duration (e.g., defense up, attack up).'
      },
      'debuff': {
        name: 'Debuff',
        desc: 'A negative effect applied to enemies that weakens them or disrupts their actions (e.g., slow, defense down).'
      },
      'crit rate up': {
        name: 'Crit Rate Up',
        desc: 'Increases a unit\'s chance to land a critical strike.\nCrits stack with almost all other damage modifiers, making them very powerful when combined with e.g. Crush Rate Up.\nThey apply to all types of attacks (basic, crit, ult) but not DOT effects.'
      },
      'crush rate up': {
        name: 'Crush Rate Up',
        desc: 'Increases a unit\'s chance to land a crushing strike.\nCrushs stack with almost all other damage modifiers, making them very powerful when combined with e.g. Crit Rate Up.\nThey apply to all types of attacks (basic, crit, ult) but not DOT effects.'
      },
      'crit damage up': {
        name: 'Crit Damage Up',
        desc: 'Increases the damage multiplier when landing critical hits.'
      },
      'crush damage up': {
        name: 'Crush Damage Up',
        desc: 'Increases the damage multiplier when landing crushing hits.'
      },
      'crit dmg up': {
        name: 'CRIT DMG UP',
        desc: 'Increases the critical damage multiplier, amplifying the damage dealt by critical hits.'
      },
      'crush dmg up': {
        name: 'CRUSH DMG UP',
        desc: 'Increases the crush damage multiplier, amplifying the damage dealt by crushing hits.'
      },
      'over crit': {
        name: 'Over Crit',
        desc: 'When reaching over 100% crit rate, each additional percent create a change to roll crit dmg up an additional time at 1.2x multiplier.\nE.g., 150 crit rate rolls crit dmg 1 time, and has 50% chance to roll it a second time for 1.2x time crit damages, for a total of a 2.2x crit damage multiplier.'
      },
      'over crush': {
        name: 'Over Crush',
        desc: 'When reaching over 100% crush rate, each additional percent create a change to roll crush dmg up an additional time at 1.2x multiplier.\nE.g., 150 crush rate rolls crush dmg 1 time, and has 50% chance to roll it a second time for 1.2x time crush damages, for a total of a 2.2x crush damage multiplier.'
      },
      'stackable': {
        name: 'Stackable',
        desc: 'Effects that can be stacked multiple times for increased potency.\nNote that effect cannot stack with themselves, e.g. Crit Rate Up applied twice from the same source won\'t stack but will stack with other stackables or non-stackable sources.'
      },
      'stacked shield': {
        name: 'Stacked Shield',
        desc: 'Grants one or more shield stacks that absorb one instance of incoming damage for a short duration. Multiple stacks can exist concurrently and are consumed as damage is taken.'
      },
      'dmg res up': {
        name: 'DMG RES Up',
        desc: 'Increases damage resistance and reduces damage taken by a percentage. Some sources may be Irremovable and/or stackable depending on the effect.'
      },
      'gigantify': {
        name: 'Gigantify',
        desc: 'Temporarily enlarges the unit. Typically improves reach/area, attack and survivability for the duration of the effect.'
      },
      'crit resistance up': {
        name: 'Crit Resistance Up',
        desc: 'Reduces the chance of being critically hit by increasing Crit Resistance. Effectively lowers attackers\' crit rate against the target.'
      },
      'crit damage down': {
        name: 'Crit Damage Down',
        desc: 'Reduces the critical damage multiplier of affected enemies, lowering the damage dealt by their critical hits.'
      },
      'incoming crit dmg up': {
        name: 'Incoming Crit DMG Up',
        desc: 'The target takes increased damage from critical hits. Often applied as a debuff on enemies to amplify your team\'s critical strikes.'
      },
      'atk up': {
        name: 'ATK Up',
        desc: 'Increases the Attack stat, boosting damage for basic, crit, and ultimate attacks.'
      },
      'add dmg': {
        name: 'ADD DMG',
        desc: 'Deals additional damage based on a condition (e.g., number of debuffs on the target) up to a specified cap.'
      },
      'atk spd down': {
        name: 'ATK SPD Down',
        desc: 'Reduces attack speed, slowing the rate of basic attacks.'
      },
      'incoming aoe dmg up': {
        name: 'Incoming AoE DMG Up',
        desc: 'The target takes increased damage from area-of-effect sources.'
      },
      'incoming aoe dmg down': {
        name: 'Incoming AoE DMG Down',
        desc: 'The target takes reduced damage from area-of-effect sources.'
      },
      'dmg res down': {
        name: 'DMG RES Down',
        desc: 'Reduces the target\'s damage resistance, causing them to take more damage from all sources.'
      },
      'remove immunity': {
        name: 'Remove Immunity',
        desc: 'Removes the target\'s Immunity, allowing damage to be taken again.'
      },
      'crit dmg taken up': {
        name: 'Crit DMG Taken Up',
        desc: 'The target takes more critical damage; functionally similar to Incoming Crit DMG Up.'
      },
      'dmg dealt up': {
        name: 'DMG Dealt UP',
        desc: 'Increases damage dealt by the affected unit by a flat percentage. Often scoped to a class (e.g., Ranged allies).'
      },
      'double hit rate up': {
        name: 'Double Hit Rate UP',
        desc: 'Increases the chance for basic attacks to strike twice. Applies only to basic attacks, not crit attacks or ultimates.'
      },
      'range up': {
        name: 'Range UP',
        desc: 'Increases the attack range, allowing the unit to hit targets from farther away.'
      },
      'atk spd up': {
        name: 'ATK SPD UP',
        desc: 'Increases attack speed, reducing the time between basic attacks.'
      },
      'triple hit rate up': {
        name: 'Triple Hit Rate UP',
        desc: 'Increases the chance for basic attacks to strike three times. Applies only to basic attacks, not crit attacks or ultimates.'
      },
      'devilmons': {
        name: 'Devilmons',
        desc: 'A resource required to trigger awakenings and unlock the full kit of a unit. Obtained from Guild Shop, events, and special missions.'
      },
      'mov spd down': {
        name: 'MOV SPD DOWN',
        desc: 'Reduces the target\'s movement speed for a short duration.'
      },
      'frostbite': {
        name: 'Frostbite',
        desc: 'Damage over time effect themed around cold; may interact with other skills. Treated as a DoT.'
      },
      'bleed': {
        name: 'Bleed',
        desc: 'Damage over time effect applied to enemies, often stacking or refreshing. Treated as a DoT.'
      },
      'burn': {
        name: 'Burn',
        desc: 'Damage over time effect themed around fire; some effects count other flames as Burn. Treated as a DoT.'
      },
      'dark flame': {
        name: 'Dark Flame',
        desc: 'A damage over time effect counted as Burn for interactions.'
      },
      'venom': {
        name: 'Venom',
        desc: 'Damage over time effect themed around poison. Treated as a DoT.'
      },
      'fear': {
        name: 'Fear',
        desc: 'Crowd control that prevents the affected target from taking actions and decreases DEF by 20% while active.'
      },
      'lovesick': {
        name: 'Lovesick',
        desc: 'A unique damage over time effect applied by certain units. Treated as a DoT and counts as Venom for interactions/synergies (e.g., ADD DMG vs Venom).'
      },
      'cdr up': {
        name: 'CDR UP',
        desc: 'Reduces skill cooldowns, allowing abilities to be used more frequently.'
      },
      'root': {
        name: 'Root',
        desc: 'Crowd control that prevents movement for the duration.'
      },
      'blind': {
        name: 'Blind',
        desc: 'Reduces hit chance or causes misses; a debuff affecting accuracy.'
      },
      'stealth': {
        name: 'Stealth',
        desc: 'Temporarily hides the unit or reduces likelihood of being targeted.'
      },
      'dampen': {
        name: 'Dampen',
        desc: 'A debuff that reduces the target\'s offensive effectiveness or damage. Applies only to basic attacks, not crit attacks or ultimates. Exact value depends on in-game description.'
      },
      'amplify': {
        name: 'Amplify',
        desc: 'Buff that increases attack modifier points per hit; does not affect DoT ticks. Applies only to basic attacks, not crit attacks or ultimates.'
      },
      'aoe dmg up': {
        name: 'AoE DMG UP',
        desc: 'Increases damage dealt by area-of-effect attacks for the affected allies.'
      },
      'crit rate down': {
        name: 'CRIT Rate DOWN',
        desc: 'Reduces the target\'s critical hit chance.'
      },
      'acc up': {
        name: 'ACC UP',
        desc: 'Increases accuracy, improving chance to apply debuffs or land hits.'
      },
      'def down': {
        name: 'DEF DOWN',
        desc: 'Reduces the target\'s defense, increasing damage taken from all sources.'
      },
      'mov spd up': {
        name: 'MOV SPD UP',
        desc: 'Increases movement speed, causing the unit to reposition faster between targets or areas.'
      },
      'def up': {
        name: 'DEF UP',
        desc: 'Increases Defense, reducing incoming damage from attacks.'
      },
      'invincibility': {
        name: 'Invincibility',
        desc: 'Prevents the unit from taking damage for the duration of the effect. Often short and used at the start of battle or during key moments.\nNote that this effect is a Shield, and can thus be dispelled by Shield Removal effects.'
      },
      'dmg down from ranged enemies': {
        name: 'DMG DOWN from Ranged Enemies',
        desc: 'Reduces damage taken from Ranged enemies specifically by a percentage.'
      },
      'crystals': {
        name: 'Crystals',
        desc: 'Primary currency used for summoning new/returning units. Spent in bulk for higher-value pulls (e.g., 10 pulls = 3,000; 100 pulls = 30,000). Earned via daily missions, events, quests, and achievements.'
      },
      'stars': {
        name: 'Stars',
        desc: 'Star rank of a unit (★). Higher stars grant significant stats and unlock additional awakenings at thresholds (notably 7★).'
      },
      'awakening': {
        name: 'Awakening',
        desc: 'Milestone bonuses unlocked at key star levels (e.g., level 3/5/7 awakenings). Provide powerful effects like buffs, debuffs, or passive bonuses.'
      },
      'breakthrough stones': {
        name: 'Breakthrough Stones',
        desc: 'Used to raise a unit\'s level cap. High-priority purchase when available in shops or events.'
      },
      'magic orbs': {
        name: 'Magic Orbs',
        desc: 'Used to pull new pieces of gear. Prioritize if you\'re expanding or upgrading equipment.'
      },
      'immunity': {
        name: 'Immunity',
        desc: 'Damage immunity that prevents all incoming damage while active. Not a crowd-control immunity. Can be removed by effects that Remove Immunity.'
      },
      'attack speed': {
        name: 'Attack Speed',
        desc: 'Determines how quickly a unit performs its basic attacks. Higher Attack Speed increases basic attack frequency. Affects only basic attacks; crit attacks and ultimates are gated by their own cooldowns (reduced by CDR UP). Double/Triple Hit modify hit count, not Attack Speed.'
      },
      'basic attack': {
        name: 'Basic Attack',
        desc: 'A unit\'s standard attack with no inherent cooldown and whose rate is governed by Attack Speed. Many effects like Double/Triple Hit Rate, Amplify, and Dampen apply only to basic attacks and do not affect crit attacks or ultimates.'
      },
      'crit attack': {
        name: 'Crit Attack',
        desc: 'Secondary skill with a base 2 sec cooldown. Cooldown is reduced by CDR UP. Not affected by basic-only effects such as Double/Triple Hit Rate, Amplify, or Dampen.'
      },
      'ultimate': {
        name: 'Ultimate',
        desc: 'Powerful skill with a base 10 sec cooldown. Cooldown is reduced by CDR UP. Also called “Exclusive Skill.” Not affected by basic-only effects.'
      },
      'exclusive skill': {
        name: 'Exclusive Skill',
        desc: 'Synonym for “Ultimate.” Base 10 sec cooldown, reduced by CDR UP. Not affected by basic-only effects.'
      },
    };

    // Helper to render keyword chips consistently
    const KW_CLASS = (kw) => ({
      'buff': 'buff',
      'debuff': 'debuff',
      'crit rate up': 'crit-rate-up',
      'crush rate up': 'crush-rate-up',
      'crit damage up': 'crit-dmg-up',
      'crush damage up': 'crush-dmg-up',
      'crit dmg up': 'crit-dmg-up',
      'crush dmg up': 'crush-dmg-up',
      'stacked shield': 'stacked-shield',
      'dmg res up': 'dmg-res-up',
      'gigantify': 'gigantify',
      'crit resistance up': 'crit-resistance-up',
      'crit damage down': 'crit-damage-down',
      'incoming crit dmg up': 'incoming-crit-dmg-up',
      'atk up': 'atk-up',
      'add dmg': 'add-dmg',
      'atk spd down': 'atk-spd-down',
      'atk spd up': 'atk-spd-up',
      'dmg dealt up': 'dmg-dealt-up',
      'double hit rate up': 'double-hit-rate-up',
      'triple hit rate up': 'triple-hit-rate-up',
      'range up': 'range-up',
  'mov spd up': 'mov-spd-up',
  'def up': 'def-up',
  'invincibility': 'invincibility',
  'dmg down from ranged enemies': 'dmg-down-from-ranged-enemies',
      'incoming aoe dmg up': 'incoming-aoe-dmg-up',
      'incoming aoe dmg down': 'incoming-aoe-dmg-down',
      'crit dmg taken up': 'crit-dmg-taken-up',
      'dmg res down': 'dmg-res-down',
      'over crit': 'over-crit',
      'over crush': 'over-crush',
      'devilmons': 'devilmons',
      'crystals': 'crystals',
      'stars': 'stars',
      'awakening': 'awakening',
      'attack speed': 'attack-speed',
      'breakthrough stones': 'breakthrough-stones',
      'magic orbs': 'magic-orbs',
      'immunity': 'invincibility',
      'aoe dmg up': 'aoe-dmg-up',
      'acc up': 'acc-up',
      'def down': 'def-down',
      'mov spd down': 'mov-spd-down',
      'cdr up': 'cdr-up',
      'root': 'root',
      'blind': 'blind',
      'stealth': 'stealth',
      'dampen': 'dampen',
      'amplify': 'amplify',
      'frostbite': 'frostbite',
      'bleed': 'bleed',
      'burn': 'burn',
      'venom': 'venom',
      'fear': 'fear',
      'remove immunity': 'remove-immunity',
      'crit rate down': 'crit-rate-down',
      'basic attack': 'basic-attack',
      'crit attack': 'crit-attack',
      'ultimate': 'ultimate',
      'exclusive skill': 'ultimate',
      'dark flame': 'burn',
      'lovesick': 'venom'
    }[kw.toLowerCase()] || 'generic');

    function renderKeywordChip(k){
      const isObj = typeof k === 'object' && k !== null;
      const name = (isObj ? k.name : String(k||''));
      const key = name.toLowerCase();
      const cls = KW_CLASS(key);
      const meta = isObj ? { appliesTo: k.appliesTo, stackable: (k.stackable === true), irremovable: (k.irremovable === true) } : null;
      let appliesBadges = '';
      if (meta){
        if (Array.isArray(meta.appliesTo)) {
          appliesBadges += meta.appliesTo.map(c=>`<span class="mini ${c}">${c.toUpperCase()}</span>`).join('');
        } else if (typeof meta.appliesTo === 'string' && meta.appliesTo) {
          appliesBadges += `<span class="mini ${meta.appliesTo}">${meta.appliesTo.toUpperCase()}</span>`;
        }
      }
      let stackBadge = '';
      if (meta && meta.stackable === true) {
        stackBadge = '<span class="mini stack">STACK</span>';
      }
      let irremBadge = '';
      if (meta && meta.irremovable === true) {
        irremBadge = '<span class="mini irrem">IRREM</span>';
      }
      return `<span class="kw ${cls}" data-kw="${key}">${name}${appliesBadges}${stackBadge}${irremBadge}</span>`;
    }

    // Minimal seed character data (placeholder until verified in Rush TD).
    // Expanded structure: id, name, class, stats85 (16 keys, TBD), kit: {basic|crit|ult: { text, dmg, hits, kws[] }}, awakening[3], keywords[], notes
    const CHARACTERS = [
      {
        id: 'shazam',
        name: 'Shazam',
        title: 'Golden Behemoth, Shazam',
        releaseDate: '2025-08-20',
        class: 'tank',
        tier: 'S',
        stats85: {
          atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD',
          def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD'
        },
        kit: {
          basic: { text: 'Deals 430% of ATK as DMG to enemies within a 2.5m narrow fan-shaped area in front.', dmg: '430', hits: 1, kws: [] },
          crit: { text: 'Deals 670% of ATK as CRIT DMG to enemies within 4m of itself. Upon a successful hit, applies 1 Stacked Shield to itself for 2 sec. Upon a successful hit, casts [Debuff] Lv. 5 CRIT DMG DOWN for 2 sec.', dmg: '670', hits: 1, kws: [{ name: 'Crit Damage Down', appliesTo: 'enemies', stackable: false }, { name: 'Stacked Shield', appliesTo: 'self', stackable: false }] },
          ult: { text: 'Deals 810% of ATK as DMG to enemies within 2m of the target. Upon a successful hit, applies a Gigantify buff to itself for 8 sec. Upon a successful hit, applies [Buff] Lv. 5 CRIT RES UP to allies for 10 sec.', dmg: '810', hits: 1, kws: [{ name: 'Gigantify', appliesTo: 'self', stackable: false }, { name: 'Crit Resistance Up', appliesTo: 'allies', stackable: false }] }
        },
        awakening: [
          { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] },
          { level: 5, text: 'Applies 3 Stacked Shields to allies at the start of the battle. Applies a DMG RES UP 10% buff to itself at the start of the battle.', kws: [{ name: 'Stacked Shield', appliesTo: 'allies', stackable: false }, { name: 'DMG RES UP', appliesTo: 'self' }] },
          { level: 7, text: 'Upon a successful hit, casts Lv. 5 Incoming CRIT DMG UP debuff for 10 sec. Increases the Monster\'s dmg dealt by 20%.', kws: [{ name: 'Incoming CRIT DMG UP', appliesTo: 'enemies', stackable: false }] }
        ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Premier tank of the game, provides stackable shields to the team at Awakening 5, as well as CRIT DMG amplification at Awakening 7.',
        recommendations: 'Awakening A5 is a must have for both PVP and PVE content.\nAwakening A7 is recommended for PVE damage amplification.\nAwakening A3 can be ignored if kiting, but is important for PVE/Boss fights.'
      },
      {
        id: 'trinity',
        name: 'Trinity',
        title: 'Debuff Intensifier, Trinity',
        releaseDate: '2025-11-19',
        class: 'melee',
        tier: 'S',
        stats85: {
          atk: '861100', hp: '16140000', acc: '7910', crit_rate: '53.94', mov_spd: '5', crush_rate: '11.50', graze_rate: '0.38', double_hit_rate: '0.13',
          def: '615100', hp_rec: '4243000', eva: '7910', crit_dmg: '355', atk_speed: '144', crush_dmg: '150', crit_res: '20.63', triple_hit_rate: '0.00'
        },
        kit: {
          basic: { text: 'Deals 290% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '290', hits: 1, kws: [] },
          crit: { text: 'Deals 190% of ATK as CRIT DMG 3 times to enemies within 3m of itself. Upon a successful hit, applies an ATK UP 20% buff to Melee allies for 2 sec. (Stackable) Deals ADD DMG based on the number of debuffs on a target. (up to 15 debuffs)', dmg: '190', hits: 3, kws: [{ name: 'ATK UP', appliesTo: 'melee', stackable: true }, { name: 'ADD DMG', appliesTo: 'self', stackable: false }] },
          ult: { text: 'Deals 840% of ATK as DMG to enemies within 3m of the target. Upon a successful hit, applies a CRIT Rate UP 20% buff to allies for 10 sec. (Stackable) Upon a successful hit, casts an ATK SPD DOWN 10% debuff for 10 sec. (Stackable)', dmg: '840', hits: 1, kws: [{ name: 'CRIT Rate UP', appliesTo: 'allies', stackable: true }, { name: 'ATK SPD DOWN', appliesTo: 'enemies', stackable: true }] }
        },
        awakening: [
          { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] },
          { level: 5, text: 'Applies 5 Stacked Shields to itself at the start of the battle.\nApplies a CRIT DMG UP 20% to itself at the start of the battle.\nUpon landing a Crush hit, casts an Incoming AoE DMG UP 10% debuff for 2 sec.', kws: [{ name: 'Stacked Shield', appliesTo: 'self' }, { name: 'CRIT DMG UP', appliesTo: 'self' }, { name: 'Incoming AoE DMG UP', appliesTo: 'enemies' }] },
          { level: 7, text: 'Upon a successful hit, casts an CRIT DMG Taken UP 10% debuff for 10 sec.\nDeals ADD DMG based on the number of debuffs on the target (up to 15 debuffs).\nIncreases the Monster\'s dmg dealt by 20%.', kws: [{ name: 'CRIT DMG Taken UP', appliesTo: 'enemies' }] }
        ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Top DPS melee unit with strong self-buffs and team support through crit rate increases.\n She is highly synergistic with high debuff counts.\n\nFull Awakening recommended.',
        recommendations: ''
      },
      {
        id: 'jager',
        name: 'Jager',
        title: 'Spell Sovereign, Jager',
        releaseDate: '2025-10-22',
        class: 'melee',
        tier: 'S',
        stats85: {
          atk: '844300', hp: '12660000', acc: '7756', crit_rate: '51.94', mov_spd: '5', crush_rate: '11.50', graze_rate: '0.38', double_hit_rate: '0.13',
          def: '646100', hp_rec: '4243000', eva: '7756', crit_dmg: '355', atk_speed: '139', crush_dmg: '150', crit_res: '20.63', triple_hit_rate: '0.00'
        },
        kit: {
          basic: { text: 'Deals 290% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '290', hits: 1, kws: [] },
          crit: { text: 'Deals 560% of ATK as CRIT DMG to enemies within a 2m x 5m area in front. Upon a successful hit, applies a Crush DMG UP 20% buff to Melee allies for 2 sec. (Stackable) Deals 5% ADD DMG based on the number of buffs it has. (up to 30 buffs)', dmg: '560', hits: 1, kws: [{ name: 'Crush DMG UP', appliesTo: 'melee', stackable: true }, { name: 'ADD DMG', appliesTo: 'self', stackable: false }] },
          ult: { text: 'Deals 770% of ATK as DMG to enemies within 3m of the target. Upon a successful hit, applies a Crush Rate UP 20% buff to allies for 10 sec. (Stackable)', dmg: '770', hits: 1, kws: [{ name: 'Crush Rate UP', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [
          { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] },
          { level: 5, text: 'Applies an Invincibility shield effect and a MOV SPD UP 200% buff to itself for 3 sec at the start of the battle.\nApplies ATK UP 10%, DEF UP 15% and DMG DOWN from Ranged Enemies 30% buffs to itself at the start of the battle', kws: [{ name: 'Invincibility', appliesTo: 'self' }, { name: 'MOV SPD UP', appliesTo: 'self' }, { name: 'ATK UP', appliesTo: 'self' }, { name: 'DEF UP', appliesTo: 'self' }, { name: 'DMG DOWN from Ranged Enemies', appliesTo: 'self' }] },
          { level: 7, text: 'Upon a successful hit, casts an CRIT DMG Taken UP 10% debuff for 10 sec.\nDeals ADD DMG based on the number of debuffs on the target (up to 15 debuffs).\nIncreases the Monster\'s dmg dealt by 20%.', kws: [{ name: 'CRIT DMG Taken UP', appliesTo: 'enemies', stackable: true }] }
        ],
        keywords: [ 'BUFF' ],
        notes: 'Top DPS melee unit with strong self-buffs and team support through crush rate increases.\n He is highly synergistic with high buff counts.\nHe is also a useful PVP unit thanks to the Invincibility shield.\nFull Awakening recommended.'
      },
      {
        id: 'sabrina',
        name: 'Sabrina',
        class: 'ranged',
        tier: 'A',
        stats85: {
          atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD',
          def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD'
        },
        kit: {
          basic: { text: 'Deals 430 % of ATK as DMG to the target.', dmg: '430', hits: 1, kws: [] },
          crit: { text: 'Deals 190 % of ATK as CRIT DMG 3 time(s) to enemies within 2m of the target.\nUpon a successful hit, applies a Lv. 5 DMG Dealt UP buff to Ranged allies for 2 sec.', dmg: '190', hits: 3, kws: [{ name: 'DMG Dealt UP', appliesTo: 'ranged', stackable: false }] },
          ult: { text: 'Deals 280 % of ATK as DMG 3 times(s) to enemies within 3m of the target.\nUpon a successful hit, applies a Lv. 5 Double Hit Rate UP buff to allies for 10 sec.', dmg: '280', hits: 3, kws: [{ name: 'Double Hit Rate UP', appliesTo: 'allies', stackable: false }] }
        },
        awakening: [
          { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] },
          { level: 5, text: 'Applies Range UP 3 and ATK SPD UP 15% buff to itself at the start of the battle.', kws: [{ name: 'Range UP', appliesTo: 'self' }, { name: 'ATK SPD UP', appliesTo: 'self' }] },
          { level: 7, text: 'Upon a successful hit, applies a Triple Hit Rate UP 10% to itself for 10 sec.\nIncreases the Monster\'s dmg dealt by 20%.', kws: [{ name: 'Triple Hit Rate UP', appliesTo: 'self', stackable: true }] }
        ],
        keywords: [
          'BUFF',
            { name: 'DMG Dealt UP', appliesTo: 'ranged', stackable: false },
            { name: 'Double Hit Rate UP', appliesTo: 'allies', stackable: false },
            { name: 'Range UP', appliesTo: 'self' },
            { name: 'ATK SPD UP', appliesTo: 'self' },
            { name: 'Triple Hit Rate UP', appliesTo: 'self', stackable: true }
        ],
        notes: 'An older and reliable ranged DPS unit with ok team buffs.\n\nNote that the Double Hit and Triple hit only apply to Basic Attacks and not Crit Attacks or Ultimates.'
      },
      {
        id: 'artamiel',
        name: 'Artamiel',
        title: 'Crescendo Arbiter, Artamiel',
        releaseDate: '2025-06-11',
        class: 'melee',
        tier: 'C',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 390% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '390', hits: 1, kws: [] },
          crit: { text: 'Deals 620% of ATK as CRIT DMG to enemies within 2m of the target. Upon a successful hit, applies a Lv. 5 Crush Rate UP buff to Melee allies for 2 sec.', dmg: '620', hits: 1, kws: [{ name: 'Crush Rate UP', appliesTo: 'melee', stackable: false }] },
          ult: { text: 'Deals 750% of ATK as DMG to enemies within 3m of the target. Upon a successful hit, casts a Lv. 5 DMG RES DOWN debuff for 10 sec.', dmg: '750', hits: 1, kws: [{ name: 'DMG RES Down', appliesTo: 'enemies', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Crescendo Arbiter, Artamiel). Class and stats to be verified in-game.'
      },
      {
        id: 'zeratu',
        name: 'Zeratu',
        title: 'Critical Overdriver, Zeratu',
        releaseDate: '2025-12-31',
        class: 'melee',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 280% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '280', hits: 1, kws: [] },
          crit: { text: 'Deals 250% of ATK as CRIT DMG 3 times to enemies within a 3m fan-shaped area in front. Upon a successful hit, applies a CRIT DMG UP 20% buff to Melee allies for 2 sec. (Stackable) Upon a successful hit, applies an AoE DMG Taken DOWN 30% buff to itself for 2 sec. (Stackable)', dmg: '250', hits: 3, kws: [{ name: 'CRIT DMG UP', appliesTo: 'melee', stackable: true }, { name: 'Incoming AoE DMG Down', appliesTo: 'self', stackable: true }] },
          ult: { text: 'Deals 840% of ATK as DMG to enemies within 3m of the target. Upon a successful hit, applies a ATK SPD UP 20% buff to allies for 10 sec. (Stackable)', dmg: '840', hits: 1, kws: [{ name: 'ATK SPD UP', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF' ],
        notes: 'Auto-generated kit from Update Notes (Critical Overdriver, Zeratu). Class and stats to be verified in-game.'
      },
      {
        id: 'seimei',
        name: 'Seimei',
        title: 'Immunity Remover, Seimei',
        releaseDate: '2025-12-03',
        class: 'ranged',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 370% of ATK as DMG to the target.', dmg: '370', hits: 1, kws: [] },
          crit: { text: 'Deals 230% of ATK as CRIT DMG 3 times to enemies within 2m of the target. Upon a successful hit, applies a Crush Rate UP 20% buff to Ranged allies for 2 sec. (Stackable)', dmg: '230', hits: 3, kws: [{ name: 'Crush Rate UP', appliesTo: 'ranged', stackable: true }] },
          ult: { text: 'Deals 200% of ATK as DMG 7 times to enemies within 2m of the target. Upon a successful hit, applies a Crush DMG UP 20% buff to allies for 10 sec. (Stackable) On every hit, places a Yin Energy stack on the target that is active for 20 sec. At 10 stacks, consumes all Yin Energy stacks on the target, removing their Immunity effect and casting a DMG RES DOWN 30% debuff for 4 sec.', dmg: '200', hits: 7, kws: [{ name: 'Crush DMG UP', appliesTo: 'allies', stackable: true }, { name: 'Remove Immunity', appliesTo: 'enemies', stackable: false }, { name: 'DMG RES Down', appliesTo: 'enemies', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Immunity Remover, Seimei). Class and stats to be verified in-game.'
      },
      {
        id: 'melissa',
        name: 'Melissa',
        title: 'Hit Booster, Melissa!',
        releaseDate: '2025-06-25',
        class: 'melee',
        tier: 'C',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 140% of ATK as DMG 2 time(s) to enemies within a 3m narrow fan-shaped area in front.', dmg: '140', hits: 2, kws: [] },
          crit: { text: 'Deals 270% of ATK as CRIT DMG 2 time(s) to enemies within a 3m fan-shaped area in front. Upon a successful hit, applies a Lv.5 CRIT DMG UP buff to Melee allies for 2 sec.', dmg: '270', hits: 2, kws: [{ name: 'CRIT DMG UP', appliesTo: 'melee', stackable: true }] },
          ult: { text: 'Deals 340% of ATK as DMG 2 time(s) to enemies within a 4m x 10m area in front. Upon a successful hit, applies a Lv.5 Amplify buff to allies for 10 sec.', dmg: '340', hits: 2, kws: [{ name: 'Amplify', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF' ],
        notes: 'Auto-generated kit from Update Notes (Hit Booster, Melissa!). Class and stats to be verified in-game.'
      },
      {
        id: 'laima',
        name: 'Laima',
        title: 'Tactical Disrupter, Laima',
        releaseDate: '2025-07-09',
        class: 'ranged',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 320% of ATK as DMG to the target.', dmg: '320', hits: 1, kws: [] },
          crit: { text: 'Deals 60% of ATK as CRIT DMG 5 times to enemies within 3m of the target. Upon a successful hit, applies an ADD ACC UP buff to Ranged allies for 2 sec. Deals ADD DMG to targets under Blind.', dmg: '60', hits: 5, kws: [{ name: 'ACC UP', appliesTo: 'ranged' }, { name: 'Blind', appliesTo: 'enemies', stackable: false }] },
          ult: { text: 'Deals 310% of ATK as DMG 2 times to enemies within 4m of the target. Upon a successful hit, casts a Root effect for 3 sec. Upon a successful hit, casts a Blind effect for 5 sec.', dmg: '310', hits: 2, kws: [{ name: 'Root', appliesTo: 'enemies', stackable: false }, { name: 'Blind', appliesTo: 'enemies', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Tactical Disrupter, Laima). Class and stats to be verified in-game.'
      },
      {
        id: 'anavel',
        name: 'Anavel',
        title: 'Frost Idol, Anavel',
        releaseDate: '2025-07-23',
        class: 'ranged',
        tier: 'B',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 370% of ATK as DMG to the target.', dmg: '370', hits: 1, kws: [] },
          crit: { text: 'Deals 160% of ATK as CRIT DMG 2 times to enemies within 3m of the target. Deals Additional DMG to targets with Frostbite. Upon a successful hit, casts [Debuff] Lv. 5 MOV SPD DOWN for 2 sec.', dmg: '160', hits: 2, kws: [{ name: 'Frostbite', appliesTo: 'enemies', stackable: false }, { name: 'MOV SPD DOWN', appliesTo: 'enemies' }] },
          ult: { text: 'Deals 480% of ATK as DMG 2 times to enemies within 3m of the target. Upon a successful hit, casts a Frostbite effect for 10 sec. Upon a successful hit, applies [Buff] Lv. 5 MOV SPD UP to allies for 10 sec.', dmg: '480', hits: 2, kws: [{ name: 'Frostbite', appliesTo: 'enemies', stackable: false }, { name: 'MOV SPD UP', appliesTo: 'allies' }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Frost Idol, Anavel). Class and stats to be verified in-game.'
      },
      {
        id: 'craka',
        name: 'Craka',
        title: 'Bloody Siren, Craka',
        releaseDate: '2025-08-06',
        class: 'melee',
        tier: 'S',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 270% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '270', hits: 1, kws: [] },
          crit: { text: 'Deals 250% of ATK as CRIT DMG 2 times to enemies within 4m of itself. Upon a successful hit, applies a Lv. 5 DMG Dealt UP buff to Melee allies for 2 sec. Deals Additional DMG to targets under Bleed.', dmg: '250', hits: 2, kws: [{ name: 'DMG Dealt UP', appliesTo: 'melee' }, { name: 'Bleed', appliesTo: 'enemies', stackable: false }] },
          ult: { text: 'Deals 430% of ATK as DMG 2 times to enemies within 3m of the target. Upon a successful hit, casts a [DoT] Bleed effect for 10 sec.', dmg: '430', hits: 2, kws: [{ name: 'Bleed', appliesTo: 'enemies', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Bloody Siren, Craka). Class and stats to be verified in-game.'
      },
      {
        id: 'dusky',
        name: 'Dusky',
        title: 'Darkflame Shade, Dusky',
        releaseDate: '2025-11-05',
        class: 'ranged',
        tier: 'S',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 360% of ATK as DMG to the target.', dmg: '360', hits: 1, kws: [] },
          crit: { text: 'Deals 230% of ATK as CRIT DMG 2 time(s) to enemies within 3m of the target. Upon a successful hit, applies a Crush DMG UP 20% buff to Ranged allies for 2 sec. (Stackable) Deals Additional DMG to targets with Burn.', dmg: '230', hits: 2, kws: [{ name: 'Crush DMG UP', appliesTo: 'ranged', stackable: true }, { name: 'Burn', appliesTo: 'enemies', stackable: false }] },
          ult: { text: 'Deals 910% of ATK as DMG 1 time to enemies within 3m of the target. Upon a successful hit, casts [CC] Fear for 2.5 sec. Upon a successful hit, casts a Dark Flame DoT effect for 10 sec. (Counts as Burn)', dmg: '910', hits: 1, kws: [{ name: 'Fear', appliesTo: 'enemies', stackable: false }, { name: 'Burn', appliesTo: 'enemies', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Darkflame Shade, Dusky). Class and stats to be verified in-game.'
      },
      {
        id: 'elenoa',
        name: 'Elenoa',
        title: 'Rose Poisoner, Elenoa',
        releaseDate: '2025-12-17',
        class: 'ranged',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 340% of ATK as DMG to the target.', dmg: '340', hits: 1, kws: [] },
          crit: { text: "Deals 430% of ATK as CRIT DMG to enemies within 3m of the target. Upon a successful hit, applies a CRIT DMG UP 20% buff to Ranged allies for 2 sec. (Stackable) Deals ADD DMG to targets under Venom.", dmg: '430', hits: 1, kws: [{ name: 'CRIT DMG UP', appliesTo: 'ranged', stackable: true }] },
          ult: { text: 'Deals 310% of ATK as DMG 3 time(s) to enemies within 3m of the target. Upon a successful hit, casts a Lovesick DoT effect for 10 sec. Upon a successful hit, applies a Lv. 5 CDR UP buff to Ranged allies for 10 sec.', dmg: '310', hits: 3, kws: [{ name: 'Lovesick', appliesTo: 'enemies', stackable: false }, { name: 'CDR UP', appliesTo: 'ranged', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Rose Poisoner, Elenoa). Class and stats to be verified in-game.'
      },
      {
        id: 'sekhmet',
        name: 'Sekhmet',
        title: 'Crimson Veil, Sekhmet',
        releaseDate: '2025-10-15',
        class: 'ranged',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 390% of ATK as DMG to the target.', dmg: '390', hits: 1, kws: [] },
          crit: { text: 'Deals 140% of ATK as CRIT DMG 3 times to enemies within 3m of the target. Upon a successful hit, applies a Lv. 5 CRIT Rate UP buff to Ranged Allies for 2 sec. (Stackable) Deals 15% ADD DMG per enemy hit. (Stacks up to 10 enemies)', dmg: '140', hits: 3, kws: [{ name: 'CRIT Rate UP', appliesTo: 'ranged', stackable: true }] },
          ult: { text: 'Deals 630% of ATK as DMG 2 times to enemies within 2m of the target. Upon a successful hit, applies a Lv. 5 AoE DMG UP buff to allies for 10 sec.', dmg: '630', hits: 2, kws: [{ name: 'AoE DMG UP', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF' ],
        notes: 'Auto-generated kit from Update Notes (Crimson Veil, Sekhmet). Class and stats to be verified in-game.'
      },
      {
        id: 'soha',
        name: 'Soha',
        title: 'Tempest Vixen, Soha',
        releaseDate: '2025-09-17',
        class: 'ranged',
        tier: 'A',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 360% of ATK as DMG to the target.', dmg: '360', hits: 1, kws: [] },
          crit: { text: 'Deals 200% of ATK as CRIT DMG 3 times to enemies within 2m of the target. Upon a successful hit, casts [Debuff] Lv. 5 CRIT Rate DOWN. Whenever successfully landing a hit, charges a Phantom Light that is active for 10 sec. At 20 charges, consumes all Phantom Lights to use CRIT Skills 2 times.', dmg: '200', hits: 3, kws: [{ name: 'CRIT Rate DOWN', appliesTo: 'enemies', stackable: true }] },
          ult: { text: 'Deals 630% of ATK as DMG 2 times to enemies within 2m of the target. Upon a successful hit, applies a Lv. 5 ATK SPD UP buff to Ranged allies for 10 sec. (Stackable)', dmg: '630', hits: 2, kws: [{ name: 'ATK SPD UP', appliesTo: 'ranged', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Tempest Vixen, Soha). Class and stats to be verified in-game.'
      },
      {
        id: 'harmonia',
        name: 'Harmonia',
        title: 'Spell Unraveler, Harmonia',
        releaseDate: '2025-10-07',
        class: 'utility',
        tier: 'B',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 480% of ATK as DMG to the target.', dmg: '480', hits: 1, kws: [] },
          crit: { text: 'Deals 580% of ATK as CRIT DMG to enemies within 3m of the target. Upon a successful hit, removes Buff effects.', dmg: '580', hits: 1, kws: [{ name: 'Remove Buffs', appliesTo: 'enemies', stackable: false }] },
          ult: { text: 'Deals 390% of ATK as DMG 2 times to enemies within 5m of itself. Upon a successful hit, applies a Lv. 5 ATK UP buff to allies for 10 sec. (Stackable)', dmg: '390', hits: 2, kws: [{ name: 'ATK UP', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF' ],
        notes: 'Auto-generated kit from Update Notes (Spell Unraveler, Harmonia). Class and stats to be verified in-game.'
      },
      {
        id: 'mago',
        name: 'Mago',
        title: 'Shadow Striker, Mago',
        releaseDate: '2025-10-01',
        class: 'melee',
        tier: 'S',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 280% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '280', hits: 1, kws: [] },
          crit: { text: 'Deals 140% of ATK as CRIT DMG 5 times to enemies within a 3m fan-shaped area in front. Upon a successful hit, casts a Lv. 5 Dampen debuff for 2 sec.', dmg: '140', hits: 5, kws: [{ name: 'Dampen', appliesTo: 'enemies', stackable: true }] },
          ult: { text: 'Deals 350% of ATK as DMG 2 times to enemies within a 4m x 15m area in front. Upon a successful hit, applies a Lv. 5 CDR UP buff to Melee allies for 10 sec. Upon a successful hit, applies a Stealth effect to itself for 3 sec.', dmg: '350', hits: 2, kws: [{ name: 'CDR UP', appliesTo: 'melee', stackable: false }, { name: 'Stealth', appliesTo: 'self', stackable: false }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Shadow Striker, Mago). Class and stats to be verified in-game.'
      },
      {
        id: 'tsuyuha',
        name: 'Tsuyuha',
        title: 'Moonlit Demoness, Tsuyuha',
        releaseDate: '2025-09-03',
        class: 'melee',
        tier: 'B',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 290% of ATK as DMG to enemies within a 3m narrow fan-shaped area in front.', dmg: '290', hits: 1, kws: [] },
          crit: { text: 'Deals 230% of ATK as DMG 2 times to enemies within a 4m x 7m area in front. Upon a successful hit, applies an ATK SPD UP 20% buff to Melee allies for 2 sec. (Stackable) Deals ADD DMG to targets under CC.', dmg: '230', hits: 2, kws: [{ name: 'ATK SPD UP', appliesTo: 'melee', stackable: true }] },
          ult: { text: 'Deals 300% of ATK as DMG 3 times to enemies within a 3m x 7m area in front. Upon a successful hit, applies [Buff] Lv. 5 Crush DMG UP to allies for 10 sec. (Stackable) Applies a DEF DOWN 20% effect to the target in under CC for 10 sec. (Stackable)', dmg: '300', hits: 3, kws: [{ name: 'Crush DMG UP', appliesTo: 'allies', stackable: true }, { name: 'DEF DOWN', appliesTo: 'enemies', stackable: true }] }
        },
        awakening: [ { level: 3, text: 'Decreases its own Skill Cooldown by 100% at the start of the battle.', kws: [] } ],
        keywords: [ 'BUFF', 'DEBUFF' ],
        notes: 'Auto-generated kit from Update Notes (Moonlit Demoness, Tsuyuha). Class and stats to be verified in-game.'
      },
      {
        id: 'zeta',
        name: 'Zeta',
        title: 'Crush Damage Stacker, Zeta',
        releaseDate: '2026-01-14',
        class: 'ranged',
        tier: 'S',
        stats85: { atk: 'TBD', hp: 'TBD', acc: 'TBD', crit_rate: 'TBD', mov_spd: 'TBD', crush_rate: 'TBD', graze_rate: 'TBD', double_hit_rate: 'TBD', def: 'TBD', hp_rec: 'TBD', eva: 'TBD', crit_dmg: 'TBD', atk_speed: 'TBD', crush_dmg: 'TBD', crit_res: 'TBD', triple_hit_rate: 'TBD' },
        kit: {
          basic: { text: 'Deals 330% of ATK as DMG to the target.', dmg: '330', hits: 1, kws: [] },
          crit: { text: 'Deals 540% of ATK as CRIT DMG to enemies within a 2m x 10m area in front. Upon a successful hit, applies a DMG UP 20% buff to Ranged allies for 2 sec. (Stackable)', dmg: '540', hits: 1, kws: [{ name: 'DMG Dealt UP', appliesTo: 'ranged', stackable: true }] },
          ult: { text: 'Deals 960% of ATK as DMG to enemies within 3m of the target. Upon a successful hit, applies 1 stack of the Crush DMG UP 10% effect to allies for 10 sec. (Stackable)', dmg: '960', hits: 1, kws: [{ name: 'Crush DMG UP', appliesTo: 'allies', stackable: true }] }
        },
        awakening: [],
        keywords: [ 'BUFF' ],
        notes: 'Zeta is mostly geared toward long battles where she can build up Crush DMG UP stacks over time. Her kit allows her to apply buffs to allies and deal significant damage to enemies.\nHer crush damage stacking mechanic gives 10% per ult (+20% with 7A) for 10 seconds, stacking up to 5 times for a total of 50% (+100% with 7A) crush damage increase. Note that the ult version has a 10 second expiry, meaning by the time you ult again, the previous stack will either be gone or nearly so. She realistically maxes at 110% crush damage increase in long fights with perfect timing.',
        recommendations: 'Zeta is only needed for long battles, in stages/rifts and PVP she will not have time to stack significantly. If you do need her, 7A is mandatory to maximize her Crush DMG UP stacking potential.'
      },
    ];
    // Normalize kits: extract any embedded "+N Awakening ..." snippets into proper awakening entries
    (function normalizeEmbeddedAwakenings(){
      const re = /\+\s*(\d)\s*Awakening\s*(.+)$/i;
      CHARACTERS.forEach(c => {
        if (!c || !c.kit) return;
        c.awakening = Array.isArray(c.awakening) ? c.awakening : [];
        ['basic','crit','ult'].forEach(k => {
          const obj = c.kit && c.kit[k];
          if (!obj || !obj.text) return;
          const txt = String(obj.text);
          const m = txt.match(re);
          if (m && typeof m.index === 'number') {
            const level = Number(m[1]);
            const awkText = m[2].trim();
            const before = txt.slice(0, m.index).trim();
            // Avoid duplicate if already present
            const exists = c.awakening.some(a => (a.level === level && (a.text||'').toLowerCase() === awkText.toLowerCase()));
            if (!exists) c.awakening.push({ level, text: awkText, kws: [] });
            obj.text = before.endsWith('.') || before === '' ? before : (before + '.');
          }
        });
        // Sort awakenings by level
        c.awakening.sort((a,b)=> (a.level||0) - (b.level||0));
      });
    })();
    
    // Build preferred keyword display casing from character chips and lexicon
    window.PREFERRED_KW_CASING = (() => {
      const map = {};
      const add = (nm) => {
        if (!nm) return;
        const key = String(nm).toLowerCase();
        if (!map[key]) map[key] = String(nm);
      };
      try {
        CHARACTERS.forEach(c => {
          (c.keywords||[]).forEach(k => add(typeof k === 'object' ? k.name : k));
          [c.kit?.basic?.kws, c.kit?.crit?.kws, c.kit?.ult?.kws]
            .filter(Boolean)
            .forEach(arr => arr.forEach(k => add(typeof k === 'object' ? k.name : k)));
          (c.awakening||[]).forEach(a => (a?.kws||[]).forEach(k => add(typeof k === 'object' ? k.name : k)));
        });
      } catch (e) {}
      try {
        Object.keys(LEXICON).forEach(k => {
          const item = LEXICON[k];
          add(item?.name || k);
        });
      } catch (e) {}
      return map;
    })();
    // Backfill missing lexicon entries so every chip has a tooltip
    (function backfillLexicon(){
      try {
        const keys = Object.keys(window.PREFERRED_KW_CASING||{});
        keys.forEach(k => {
          if (!LEXICON[k]) {
            LEXICON[k] = { name: window.PREFERRED_KW_CASING[k] || k.replace(/\b\w/g, m=>m.toUpperCase()), desc: 'No description available yet.' };
          }
        });
      } catch(e){}
    })();
    (function initKeywordFilter(){
      const allKws = new Set(['buff','debuff','crit rate up','crush rate up','crit damage up']);
      CHARACTERS.forEach(c => {
        (c.keywords||[]).forEach(k => allKws.add((typeof k === 'object' ? k.name : k).toLowerCase()));
        [c.kit?.basic?.kws, c.kit?.crit?.kws, c.kit?.ult?.kws].filter(Boolean).forEach(arr => arr.forEach(k => allKws.add((typeof k === 'object' ? k.name : k).toLowerCase())));
        (c.awakening||[]).forEach(a => (a?.kws||[]).forEach(k => allKws.add((typeof k === 'object' ? k.name : k).toLowerCase())));
      });
      const wrap = document.getElementById('keyword-boxes');
      if (!wrap) return;
      wrap.innerHTML = '';
      const all = [...allKws];
      const cats = ['buff','debuff'].filter(x => all.includes(x));
      const others = all.filter(k => !cats.includes(k)).sort();

      function renderKwItem(k, isCat){
        const id = 'kw-' + String(k).toLowerCase().replace(/\s+/g, '-');
        const input = document.createElement('input');
        input.type = 'checkbox'; input.className = 'kw-check'; input.id = id; input.value = k;
        const label = document.createElement('label');
        label.className = 'kw-label' + (isCat ? ' kw-cat' : '');
        label.setAttribute('for', id);
        const lower = String(k).toLowerCase();
        const display = (window.PREFERRED_KW_CASING && window.PREFERRED_KW_CASING[lower]) ? window.PREFERRED_KW_CASING[lower] : String(k);
        label.innerHTML = `<span class="kw ${KW_CLASS(k)}" data-kw="${lower}">${display}</span>`;
        wrap.appendChild(input);
        wrap.appendChild(label);
      }

      // Render BUFF then DEBUFF at the top, side-by-side, then force a line break before others
      cats.forEach(k => renderKwItem(k, true));
      const sep = document.createElement('div');
      sep.className = 'kw-sep';
      wrap.appendChild(sep);
      // Render remaining keywords afterward
      others.forEach(k => renderKwItem(k, false));
    })();

    // Build awakening checkbox group (A3, A5, A7)
    (function initAwakeningFilter(){
      const wrap = document.getElementById('awakening-boxes');
      if (!wrap) return;
      wrap.innerHTML = '';
      [3,5,7].forEach(level => {
        const id = 'awk-' + level;
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'awk-check';
        input.id = id;
        input.value = String(level);
        // Default ON: awakening filters are checked by default
        input.checked = true;
        const label = document.createElement('label');
        label.className = 'kw-label';
        label.setAttribute('for', id);
        label.innerHTML = `<span class="kw awakening awk-l${level}" data-kw="awakening">A${level}</span>`;
        wrap.appendChild(input);
        wrap.appendChild(label);
      });
    })();
    
    // Build class radio chip group
    (function initClassFilter(){
      const classes = ['melee','ranged','utility','tank'];
      const wrap = document.getElementById('class-boxes');
      if (!wrap) return;
      wrap.innerHTML = '';
      classes.forEach(cls => {
        const id = 'cls-' + cls;
        const input = document.createElement('input');
        input.type = 'radio'; input.className = 'cls-radio'; input.id = id; input.name = 'class-filter'; input.value = cls;
        const label = document.createElement('label');
        label.className = 'kw-label'; label.setAttribute('for', id);
        label.innerHTML = `<span class="kw ${cls === 'melee' ? 'cls-melee' : cls === 'ranged' ? 'cls-ranged' : cls === 'utility' ? 'cls-utility' : 'cls-tank'}">${cls[0].toUpperCase()+cls.slice(1)}</span>`;
        wrap.appendChild(input);
        wrap.appendChild(label);
      });
    })();

    // Render lexicon
    function renderLexicon(){
      const wrap = document.getElementById('lexicon');
      const q = (document.getElementById('lex-search')?.value || '').trim().toLowerCase();
      wrap.innerHTML = '';
      function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
      // Build combined matcher for one-pass chipification
      const pluralizable = new Set(['basic attack','crit attack','ultimate','exclusive skill']);
      const lexEntries = Object.keys(LEXICON).map(k => ({ key: k, name: (LEXICON[k]?.name || k) }));
      // Sort by display name length desc to favor longer matches
      lexEntries.sort((a,b)=> (b.name||'').length - (a.name||'').length);
      const pattern = lexEntries.map(({key, name}) => {
        const base = escapeRegExp(String(name).toLowerCase());
        return pluralizable.has(key) ? `${base}s?` : base;
      }).join('|');
      const chipify = (text) => {
        if (!text) return '';
        const re = new RegExp(`\\b(?:${pattern})\\b`, 'gi');
        return String(text).replace(re, (m) => {
          let norm = m.toLowerCase();
          let plural = false;
          if (norm.endsWith('s')) {
            const base = norm.slice(0, -1);
            if (pluralizable.has(base)) norm = base;
            if (pluralizable.has(base)) plural = true;
          }
          const cls = KW_CLASS(norm);
          const preferred = (window.PREFERRED_KW_CASING && window.PREFERRED_KW_CASING[norm]) ? window.PREFERRED_KW_CASING[norm] : (LEXICON[norm]?.name || m);
          const label = plural ? `${preferred}s` : preferred;
          return `<span class="kw ${cls}" data-kw="${norm}">${label}</span>`;
        });
      };
      Object.keys(LEXICON).sort().forEach(key => {
        const item = LEXICON[key];
        const text = `${item.name} ${item.desc}`.toLowerCase();
        if (!q || text.includes(q)) {
          const div = document.createElement('div');
          div.className = 'lex-item';
          const cls = KW_CLASS(key);
          const descHtml = chipify(item.desc);
          div.innerHTML = `<div class="lex-term"><span class="kw ${cls}" data-kw="${key}" data-no-tt="1">${item.name}</span></div><div class="lex-desc">${descHtml}</div>`;
          wrap.appendChild(div);
        }
      });
    }

    // Render character cards
    function parseReleaseTs(s){
      if (!s) return -Infinity;
      // Accept common formats (ISO or 'YYYY-MM-DD HH:mm:ss')
      const t = Date.parse(s.replace(/-/g,'/')) || Date.parse(s);
      return Number.isFinite(t) ? t : -Infinity;
    }

    function renderCards(){
      const q = document.getElementById('search').value.trim().toLowerCase();
      const clsRadio = document.querySelector('#class-boxes input.cls-radio:checked');
      const cls = clsRadio ? clsRadio.value : 'all';
      const selectedKws = Array.from(document.querySelectorAll('#keyword-boxes input.kw-check:checked')).map(o => o.value.toLowerCase());
      const hideSelf = !!document.getElementById('hide-self-btn')?.classList.contains('active');
      const stackOnly = !!document.getElementById('stack-only-btn')?.classList.contains('active');
      const awkSel = Array.from(document.querySelectorAll('#awakening-boxes input.awk-check:checked')).map(o => parseInt(o.value, 10)).filter(n => [3,5,7].includes(n));
      let list = CHARACTERS.filter(c => {
        // Include keyword names from character-level, kit, and awakenings in free-text search
        const awkKws = (c.awakening||[])
          .filter(a => !awkSel.length || awkSel.includes(a.level))
          .flatMap(a => (a?.kws||[]));
        const kwNames = [
          ...(c.keywords||[]),
          ...((c.kit?.basic?.kws)||[]),
          ...((c.kit?.crit?.kws)||[]),
          ...((c.kit?.ult?.kws)||[]),
          ...awkKws
        ].map(k => (typeof k === 'object' && k ? String(k.name||'') : String(k||''))).join(' ');
        const matchText = `${c.title||c.name} ${c.class} ${c.notes} ${c.kit?.basic?.text||''} ${c.kit?.crit?.text||''} ${c.kit?.ult?.text||''} ${kwNames}`.toLowerCase();
        const passQ = !q || matchText.includes(q);
        const passCls = (cls === 'all') || (c.class === cls);
        // Helper to detect self-only targets
        const isSelfOnly = (appliesTo) => {
          if (!appliesTo) return false;
          if (typeof appliesTo === 'string') return appliesTo.trim().toLowerCase() === 'self';
          if (Array.isArray(appliesTo)) return appliesTo.length > 0 && appliesTo.every(t => String(t).trim().toLowerCase() === 'self');
          return false;
        };
        const normalize = (k) => {
          if (typeof k === 'object' && k) return { name: String(k.name||'').toLowerCase(), appliesTo: k.appliesTo, stackable: (k.stackable === true) };
          return { name: String(k||'').toLowerCase(), appliesTo: undefined, stackable: false };
        };
        const normalizedAll = [
          ...((c.keywords||[]).filter(k => {
            const nm = (typeof k === 'object' ? k.name : k);
            const key = String(nm||'').trim().toLowerCase();
            return key === 'buff' || key === 'debuff';
          })),
          ...((c.kit?.basic?.kws)||[]),
          ...((c.kit?.crit?.kws)||[]),
          ...((c.kit?.ult?.kws)||[]),
          ...((c.awakening||[])
            .filter(a => !awkSel.length || awkSel.includes(a.level))
            .flatMap(a => (a?.kws||[])))
        ].map(normalize);
        const filteredForMatching = normalizedAll
          .filter(e => !hideSelf || !isSelfOnly(e.appliesTo))
          .filter(e => !stackOnly || e.stackable === true);
        const allKeywords = filteredForMatching.map(e => e.name);
        const passKw = (!selectedKws.length) || selectedKws.every(k => allKeywords.includes(k));
        let passToggles = true;
        if (!selectedKws.length && (hideSelf || stackOnly)) {
          // When no keyword is explicitly selected, require at least one effect keyword that survives toggles
          passToggles = filteredForMatching.some(e => e.name !== 'buff' && e.name !== 'debuff');
        }
        return passQ && passCls && passKw && passToggles;
      });

      // Sort by releaseDate descending (newest first); items without releaseDate go last
      list.sort((a,b) => (parseReleaseTs(b.releaseDate) - parseReleaseTs(a.releaseDate)) || 0);

      const wrap = document.getElementById('cards');
      wrap.innerHTML = '';

      if (!list.length) {
        const empty = document.createElement('div');
        empty.style.gridColumn = '1 / -1';
        empty.style.opacity = '.8';
        empty.textContent = 'No characters match your filters. Try deselecting some keywords or clearing class/search filters.';
        wrap.appendChild(empty);
        return;
      }

      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';
        const badgeClass = c.class === 'melee' ? 'cls-melee' : c.class === 'ranged' ? 'cls-ranged' : c.class === 'utility' ? 'cls-utility' : 'cls-tank';
        const rawKws = (c.keywords||[]);
        const catItems = rawKws.filter(k => {
          const nm = (typeof k === 'object' ? k.name : k);
          const key = String(nm||'').trim().toLowerCase();
          return key === 'buff' || key === 'debuff';
        });
        // Build effect chips from kit + awakening (selected levels only), not character-level duplicates
        let effItems = [
          ...((c.kit?.basic?.kws)||[]),
          ...((c.kit?.crit?.kws)||[]),
          ...((c.kit?.ult?.kws)||[]),
          ...((c.awakening||[])
            .filter(a => {
              const lv = (typeof a === 'object' && a) ? a.level : undefined;
              return !awkSel.length || awkSel.includes(lv);
            })
            .flatMap(a => (a?.kws||[])))
        ];
        if (hideSelf || stackOnly) {
          const selfOnly = (appliesTo) => {
            if (!appliesTo) return false;
            if (typeof appliesTo === 'string') return appliesTo.trim().toLowerCase() === 'self';
            if (Array.isArray(appliesTo)) return appliesTo.length > 0 && appliesTo.every(t => String(t).trim().toLowerCase() === 'self');
            return false;
          };
          if (hideSelf) {
            effItems = effItems.filter(k => !(typeof k === 'object' && selfOnly(k.appliesTo)));
          }
          if (stackOnly) {
            effItems = effItems.filter(k => (typeof k === 'object' && k.stackable === true));
          }
        }
        const catChips = catItems.map(k=>renderKeywordChip(k)).join('');
        const effChips = effItems.map(k=>renderKeywordChip(k)).join('');
        const catRow = catChips ? `<div class="keywords kw-cats">${catChips}</div>` : '';
        const effRow = effChips ? `<div class="keywords kw-effects">${effChips}</div>` : '';
        const hasBasic = !!(c.kit && c.kit.basic && c.kit.basic.text && String(c.kit.basic.text).trim());
        const hasCrit =  !!(c.kit && c.kit.crit  && c.kit.crit.text  && String(c.kit.crit.text).trim());
        const hasUlt =   !!(c.kit && c.kit.ult   && c.kit.ult.text   && String(c.kit.ult.text).trim());
        const awkCount = Array.isArray(c.awakening) ? c.awakening.length : 0;
        const incomplete = !(hasBasic && hasCrit && hasUlt) || awkCount < 3;
        const rel = c.releaseDate ? `<div class="release">Released: ${String(c.releaseDate).split(' ')[0]}</div>` : '';
        card.innerHTML = `
          <span class="badge ${badgeClass}">${c.class.toUpperCase()}</span>
          <h3>${c.title || c.name}</h3>
          ${rel}
          <div class="statline">
            <div class="stat"><span class="lab">HP</span><span class="val">${formatCompactValue(c.stats85.hp)}</span></div>
            <div class="stat"><span class="lab">ATK</span><span class="val">${formatCompactValue(c.stats85.atk)}</span></div>
            <div class="stat"><span class="lab">DEF</span><span class="val">${formatCompactValue(c.stats85.def)}</span></div>
            <div class="stat"><span class="lab">ATK SPD</span><span class="val">${formatCompactValue(c.stats85.atk_speed)}</span></div>
          </div>
          ${catRow}
          ${effRow}
          <div class="card-actions">
            <button class="btn" data-id="${c.id}">View Details</button>
            ${incomplete ? '<span class="incomplete">Incomplete Kit</span>' : ''}
          </div>
        `;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll('button[data-id]').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.getAttribute('data-id');
        openModal(id);
        updateUrlFromUI();
      }));
    }

    // --- URL state management ---
    function readStateFromUrl(){
      const params = new URLSearchParams(window.location.search);
      const t = params.get('tab');
      const tab = (t === 'lexicon' || t === 'characters' || t === 'general' || t === 'tiers') ? t : 'general';
      const q = params.get('q') || '';
      const cls = params.get('cls') || '';
      const kws = (params.get('kws') || '').split(',').filter(Boolean).map(s => s.trim());
      const lq = params.get('lq') || '';
      const char = params.get('char') || '';
      const noself = params.get('noself') === '1' || params.get('noself') === 'true';
      const stack = params.get('stack') === '1' || params.get('stack') === 'true';
      const awkParam = (params.get('awk') || '').split(',').filter(Boolean);
      const awk = awkParam.map(v => parseInt(v, 10)).filter(n => [3,5,7].includes(n));
      return { tab, q, cls, kws, lq, char, noself, stack, awk };
    }

    function setActiveTab(tab){
      const targetId = `tab-${tab}`;
      const targetEl = document.getElementById(targetId) ? targetId : 'tab-characters';
      document.querySelectorAll('.tab-btn').forEach(x => {
        const isTarget = x.getAttribute('data-tab') === targetEl;
        x.classList.toggle('active', isTarget);
      });
      document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === targetEl));
      const disc = document.getElementById('tier-disclaimer');
      if (disc) disc.style.display = (targetEl === 'tab-tiers') ? '' : 'none';
    }

    function renderTierList(){
      const wrap = document.getElementById('tier-grid');
      if (!wrap) return;
      wrap.innerHTML = '';
      const order = ['S','A','B','C','Untiered'];
      const buckets = Object.fromEntries(order.map(t => [t, []]));
      (typeof CHARACTERS !== 'undefined' ? CHARACTERS : []).forEach(c => {
        const raw = (c.tier || '').toString().trim().toUpperCase();
        const key = order.includes(raw) ? raw : 'Untiered';
        buckets[key].push(c);
      });
      // Sort each bucket by most recent release first; unknown dates last
      order.forEach(t => {
        buckets[t].sort((a,b) => {
          const byDate = (parseReleaseTs(b.releaseDate) - parseReleaseTs(a.releaseDate)) || 0;
          if (byDate !== 0) return byDate;
          const an = (a.title || a.name || '').toString();
          const bn = (b.title || b.name || '').toString();
          return an.localeCompare(bn);
        });
      });
      order.forEach(t => {
        const row = document.createElement('div');
        row.className = 'tier-row tier-' + t;
        const title = document.createElement('div');
        title.className = 'tier-title';
        title.textContent = t;
        const items = document.createElement('div');
        items.className = 'tier-items';
        buckets[t].forEach(c => {
          const btn = document.createElement('button');
          const cls = (c.class || '').toLowerCase();
          const clsClass = cls === 'melee' ? 'cls-melee' : cls === 'ranged' ? 'cls-ranged' : cls === 'utility' ? 'cls-utility' : cls === 'tank' ? 'cls-tank' : '';
          btn.className = 'char-chip' + (clsClass ? (' ' + clsClass) : '');
          btn.dataset.id = c.id;
          btn.textContent = c.name || c.title || 'Unit';
          items.appendChild(btn);
        });
        row.appendChild(title);
        row.appendChild(items);
        wrap.appendChild(row);
      });
      // Bind chip clicks
      wrap.querySelectorAll('.char-chip').forEach(b => b.addEventListener('click', (e) => {
        const id = e.currentTarget.dataset.id;
        if (id) {
          openModal(id);
          updateUrlFromUI();
        }
      }));
    }

    function applyStateToUI(state){
      // Tab
      setActiveTab(state.tab || 'general');
      // Character search
      const search = document.getElementById('search');
      if (search) search.value = state.q || '';
      // Lexicon search
      const lsearch = document.getElementById('lex-search');
      if (lsearch) lsearch.value = state.lq || '';
      // Class radio
      const cls = (state.cls||'').toLowerCase();
      document.querySelectorAll('#class-boxes input.cls-radio').forEach(r => { r.checked = !!cls && r.value === cls; });
      // Keyword checkboxes
      const sel = new Set((state.kws||[]).map(x => x.toLowerCase()));
      document.querySelectorAll('#keyword-boxes input.kw-check').forEach(c => { c.checked = sel.has(String(c.value||'').toLowerCase()); });
      // Hide self-only toggle
      const toggle = document.getElementById('hide-self-btn');
      if (toggle) {
        toggle.classList.toggle('active', !!state.noself);
        toggle.setAttribute('aria-pressed', !!state.noself);
      }
      // Stackable-only toggle
      const stToggle = document.getElementById('stack-only-btn');
      if (stToggle) {
        stToggle.classList.toggle('active', !!state.stack);
        stToggle.setAttribute('aria-pressed', !!state.stack);
      }
      // Awakening checkboxes
      const awkSel = new Set((state.awk||[]).map(Number));
      const awkInputs = document.querySelectorAll('#awakening-boxes input.awk-check');
      if (awkSel.size === 0) {
        // No URL param: default to all awakening levels ON
        awkInputs.forEach(c => { c.checked = true; });
      } else {
        awkInputs.forEach(c => { c.checked = awkSel.has(parseInt(c.value, 10)); });
      }
    }

    function getUIState(){
      const activeId = document.querySelector('.panel.active')?.id || 'tab-characters';
      const tab = activeId.replace(/^tab-/, '');
      const q = document.getElementById('search')?.value?.trim() || '';
      const lq = document.getElementById('lex-search')?.value?.trim() || '';
      const clsRadio = document.querySelector('#class-boxes input.cls-radio:checked');
      const cls = clsRadio ? clsRadio.value : '';
      const kws = Array.from(document.querySelectorAll('#keyword-boxes input.kw-check:checked')).map(o => o.value.trim());
      const modalEl = document.getElementById('modal');
      const char = (modalEl && modalEl.open && modalEl.dataset && modalEl.dataset.char) ? modalEl.dataset.char : '';
      const noself = !!document.getElementById('hide-self-btn')?.classList.contains('active');
      const stack = !!document.getElementById('stack-only-btn')?.classList.contains('active');
      const awk = Array.from(document.querySelectorAll('#awakening-boxes input.awk-check:checked')).map(o => parseInt(o.value, 10)).filter(n => [3,5,7].includes(n));
      return { tab, q, cls, kws, lq, char, noself, stack, awk };
    }

    function updateUrlFromUI(){
      const s = getUIState();
      const params = new URLSearchParams();
      params.set('tab', s.tab);
      if (s.q) params.set('q', s.q);
      if (s.cls) params.set('cls', s.cls);
      if (s.kws && s.kws.length) params.set('kws', s.kws.join(','));
      if (s.lq) params.set('lq', s.lq);
      if (s.char) params.set('char', s.char);
      if (s.noself) params.set('noself', '1');
      if (s.stack) params.set('stack', '1');
      if (s.awk && s.awk.length) params.set('awk', s.awk.join(','));
      const url = `${location.pathname}?${params.toString()}`;
      history.replaceState(null, '', url);
    }

      // --- Keyword tooltip wiring ---
      (function initKeywordTooltips(){
        // Two tooltips: one for base page, one inside an open dialog (top layer)
        let ttGlobal = null; // appended to body
        let ttModal = null;  // appended to dialog when needed
        let ttEl = null;     // currently active tooltip element
        let currentAnchor = null;

        function createTooltip(){
          const el = document.createElement('div');
          el.className = 'kw-tooltip';
          el.innerHTML = '<div class="tt-term"></div><div class="tt-desc"></div>';
          return el;
        }

        function getTooltipForAnchor(anchor){
          const dlg = anchor?.closest && anchor.closest('dialog[open]');
          if (dlg) {
            if (!ttModal) {
              ttModal = createTooltip();
              dlg.appendChild(ttModal);
            }
            return ttModal;
          }
          if (!ttGlobal) {
            ttGlobal = createTooltip();
            document.body.appendChild(ttGlobal);
          }
          return ttGlobal;
        }

        function setContent(el, termKey){
          const key = String(termKey||'').toLowerCase();
          const item = LEXICON[key];
          const term = item?.name || (termKey ? String(termKey).replace(/\b\w/g, m=>m.toUpperCase()) : 'Keyword');
          const desc = item?.desc || 'No description available yet.';
          el.querySelector('.tt-term').textContent = term;
          el.querySelector('.tt-desc').textContent = desc;
        }

        function position(anchor){
          if (!ttEl || !anchor) return;
          const rect = anchor.getBoundingClientRect();
          const pad = 8;
          const top = rect.bottom + pad;
          const left = Math.min(Math.max(rect.left + rect.width/2 - 160, 8), window.innerWidth - 8 - 320);
          ttEl.style.top = `${Math.min(top, window.innerHeight - ttEl.offsetHeight - 8)}px`;
          ttEl.style.left = `${left}px`;
        }

        function show(anchor, key){
          currentAnchor = anchor;
          ttEl = getTooltipForAnchor(anchor);
          // Hide the other tooltip if it is visible
          if (ttEl === ttGlobal && ttModal) ttModal.classList.remove('show');
          if (ttEl === ttModal && ttGlobal) ttGlobal.classList.remove('show');
          setContent(ttEl, key);
          position(anchor);
          requestAnimationFrame(()=> ttEl.classList.add('show'));
        }

        function hide(){
          if (ttGlobal) ttGlobal.classList.remove('show');
          if (ttModal) ttModal.classList.remove('show');
          currentAnchor = null;
        }

        // Show on hover
        document.addEventListener('mouseover', (e) => {
          const chip = e.target.closest('.kw');
          if (!chip) return;
          if (chip.dataset.noTt === '1') return;
          const key = chip.dataset.kw || chip.textContent.trim().toLowerCase();
          show(chip, key);
        });
        // Reposition while moving
        document.addEventListener('mousemove', (e) => {
          if (!ttEl || !currentAnchor || !ttEl.classList.contains('show')) return;
          position(currentAnchor);
        });
        // Hide when leaving any .kw entirely
        document.addEventListener('mouseout', (e) => {
          const from = e.target.closest('.kw');
          const to = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest('.kw') : null;
          if (from && !to) hide();
        });
        // Hide on scroll or when window resizes
        window.addEventListener('scroll', hide, true);
        window.addEventListener('resize', hide);
      })();

      // Helper: format numeric stats with compact units (K/M) and 2 decimals
      function formatCompactValue(val){
        if (val === null || val === undefined) return 'TBD';
        if (typeof val === 'number') return formatNumberShort(val);
        const s = String(val).trim();
        if (s === '' || s.toLowerCase() === 'tbd') return 'TBD';
        // leave non-numeric strings (e.g., percentages) untouched
        const n = Number(s);
        if (!isNaN(n)) return formatNumberShort(n);
        return val;
      }

      function formatNumberShort(n){
        const abs = Math.abs(n);
        if (abs >= 1000000) return (n/1000000).toFixed(2) + 'M';
        if (abs >= 1000) return (n/1000).toFixed(2) + 'K';
        return n.toString();
      }

    // Helper: format percentage stats without K/M notation and with a % suffix
    function formatPercentValue(val){
      if (val === null || val === undefined) return 'TBD';
      const s = String(val).trim();
      if (s === '' || s.toLowerCase() === 'tbd') return 'TBD';
      if (s.endsWith('%')) return s; // already formatted
      const n = Number(s);
      if (!isNaN(n)) return (Number.isInteger(n) ? n.toString() : s) + '%';
      return s;
    }

    // Helper: render full stats grid from expanded schema
    function renderStatsGrid(stats){
      const labels = {
        hp: 'HP', atk: 'ATK', def: 'DEF', atk_speed: 'ATK SPD',
        acc: 'ACC', crit_rate: 'CRIT Rate', crit_dmg: 'CRIT Dmg', crit_res: 'CRIT Res',
        mov_spd: 'MOV SPD', hp_rec: 'HP REC', eva: 'EVA',
        crush_rate: 'CRUSH Rate', crush_dmg: 'CRUSH Dmg', graze_rate: 'GRAZE Rate',
        double_hit_rate: 'DOUBLE Hit', triple_hit_rate: 'TRIPLE Hit'
      };
        const percentKeys = new Set(['crit_rate','crush_rate','graze_rate','double_hit_rate','triple_hit_rate','crit_res','crush_dmg','crit_dmg']);
        return Object.keys(labels).map(k => {
          const raw = (stats && stats[k] !== undefined) ? stats[k] : 'TBD';
          const val = percentKeys.has(k) ? formatPercentValue(raw) : formatCompactValue(raw);
          return `<div class="stat"><span class="lab">${labels[k]}</span><span class="val">${val}</span></div>`;
        }).join('');
    }

    function openModal(id){
      const c = CHARACTERS.find(x => x.id === id);
      if (!c) return;
      const modal = document.getElementById('modal');
      if (modal && modal.dataset) modal.dataset.char = id;
      document.getElementById('modal-title').textContent = c.title || c.name;
      const badge = document.getElementById('modal-badge');
  badge.textContent = c.class.toUpperCase();
  badge.className = 'badge ' + (c.class === 'melee' ? 'cls-melee' : c.class === 'ranged' ? 'cls-ranged' : c.class === 'utility' ? 'cls-utility' : 'cls-tank');

      // Dynamic stats render
      const statsWrap = document.getElementById('m-stats');
      if (statsWrap) statsWrap.innerHTML = renderStatsGrid(c.stats85);

      // Character-level keywords in modal: split BUFF/DEBUFF (category) vs other effects
      const kwWrap = document.getElementById('m-kws');
      if (kwWrap) {
        const rawKws = (c.keywords||[]);
        const catItems = rawKws.filter(k => {
          const nm = (typeof k === 'object' ? k.name : k);
          const key = String(nm||'').trim().toLowerCase();
          return key === 'buff' || key === 'debuff';
        });
        const effItems = rawKws.filter(k => {
          const nm = (typeof k === 'object' ? k.name : k);
          const key = String(nm||'').trim().toLowerCase();
          return key !== 'buff' && key !== 'debuff';
        });
        const catChips = catItems.map(k=>renderKeywordChip(k)).join('');
        const effChips = effItems.map(k=>renderKeywordChip(k)).join('');
        const catRow = catChips ? `<div class="keywords kw-cats">${catChips}</div>` : '';
        const effRow = effChips ? `<div class="keywords kw-effects">${effChips}</div>` : '';
        // Ensure the outer wrapper isn't a flex row to avoid nested .keywords flex
        kwWrap.classList.remove('keywords');
        kwWrap.innerHTML = catRow + effRow;
      }

      // Incomplete warning in modal kit section
      (function setIncomplete(){
        const hasBasic = !!(c.kit && c.kit.basic && c.kit.basic.text && String(c.kit.basic.text).trim());
        const hasCrit =  !!(c.kit && c.kit.crit  && c.kit.crit.text  && String(c.kit.crit.text).trim());
        const hasUlt =   !!(c.kit && c.kit.ult   && c.kit.ult.text   && String(c.kit.ult.text).trim());
        const awkCount = Array.isArray(c.awakening) ? c.awakening.length : 0;
        const inc = !(hasBasic && hasCrit && hasUlt) || awkCount < 3;
        const el = document.getElementById('m-incomplete');
        if (el) el.style.display = inc ? '' : 'none';
      })();

      // Ability descriptions + meta
      document.getElementById('m-basic').textContent = c.kit?.basic?.text || '—';
      document.getElementById('m-crit').textContent = c.kit?.crit?.text || '—';
      document.getElementById('m-ult').textContent = c.kit?.ult?.text || '—';

      document.getElementById('m-basic-meta').textContent = `Damage: ${c.kit?.basic?.dmg || 'TBD'}% × ${c.kit?.basic?.hits || 'TBD'} hit${(c.kit?.basic?.hits||0) === 1 ? '' : 's'}`;
      document.getElementById('m-crit-meta').textContent = `Damage: ${c.kit?.crit?.dmg || 'TBD'}% × ${c.kit?.crit?.hits || 'TBD'} hit${(c.kit?.crit?.hits||0) === 1 ? '' : 's'}`;
      document.getElementById('m-ult-meta').textContent = `Damage: ${c.kit?.ult?.dmg || 'TBD'}% × ${c.kit?.ult?.hits || 'TBD'} hit${(c.kit?.ult?.hits||0) === 1 ? '' : 's'}`;

      document.getElementById('m-basic-kws').innerHTML = (c.kit?.basic?.kws||[]).map(k=>renderKeywordChip(k)).join('');
      document.getElementById('m-crit-kws').innerHTML = (c.kit?.crit?.kws||[]).map(k=>renderKeywordChip(k)).join('');
      document.getElementById('m-ult-kws').innerHTML = (c.kit?.ult?.kws||[]).map(k=>renderKeywordChip(k)).join('');

      const awks = document.getElementById('m-awks');
      awks.innerHTML = '';
      (c.awakening||[]).forEach(a => {
        const li = document.createElement('li');
        if (typeof a === 'string') {
          li.textContent = a;
        } else {
          const name = a.level ? `Awakening ${a.level}` : 'Awakening';
          const chips = (a.kws||[]).map(k=>renderKeywordChip(k)).join('');
          li.innerHTML = `<div class="awk-name">${name}</div><div class="awk-desc">${a.text||''}</div><div class="keywords">${chips}</div>`;
        }
        awks.appendChild(li);
      });

      document.getElementById('m-notes').textContent = c.notes || '—';
      const recoEl = document.getElementById('m-reco');
      if (recoEl) {
        const rec = (typeof c.recommendations === 'string') ? c.recommendations.trim() : '';
        recoEl.textContent = rec || '—';
      }

      modal.showModal();
      // Reflect modal state in URL
      updateUrlFromUI();
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
      const id = b.getAttribute('data-tab');
      const tabKey = (id || 'tab-characters').replace(/^tab-/, '');
      setActiveTab(tabKey);
      // Update URL to reflect tab change
      updateUrlFromUI();
      // Re-render tier list if visible
      renderTierList();
    }));

    document.getElementById('modal-close').addEventListener('click', () => {
      const m = document.getElementById('modal');
      if (m && m.dataset) m.dataset.char = '';
      m.close();
      updateUrlFromUI();
    });

    // Close modal when clicking outside of it (on the backdrop)
    (function enableModalBackdropClose(){
      const m = document.getElementById('modal');
      if (!m) return;
      m.addEventListener('click', (e) => {
        const rect = m.getBoundingClientRect();
        const inDialog = (
          e.clientX >= rect.left && e.clientX <= rect.right &&
          e.clientY >= rect.top && e.clientY <= rect.bottom
        );
        if (!inDialog) {
          if (m && m.dataset) m.dataset.char = '';
          m.close();
          updateUrlFromUI();
        }
      });
    })();

    // Filters/search
  ['search'].forEach(id => document.getElementById(id).addEventListener('input', () => { renderCards(); updateUrlFromUI(); }));
  const kwBoxes = document.getElementById('keyword-boxes');
  if (kwBoxes) kwBoxes.addEventListener('change', () => { renderCards(); updateUrlFromUI(); });
  const awkBoxes = document.getElementById('awakening-boxes');
  if (awkBoxes) awkBoxes.addEventListener('change', () => { renderCards(); updateUrlFromUI(); });
  const clsBoxes = document.getElementById('class-boxes');
  if (clsBoxes) {
    clsBoxes.addEventListener('change', () => { renderCards(); updateUrlFromUI(); });
    // Make class chips toggleable: clicking selects; clicking again deselects
    clsBoxes.addEventListener('click', (e) => {
      const label = e.target.closest('label.kw-label');
      const input = label ? document.getElementById(label.getAttribute('for')) : (e.target.matches('input.cls-radio') ? e.target : null);
      if (!input) return;
      e.preventDefault();
      if (input.checked) {
        input.checked = false;
      } else {
        // Ensure only one is selected
        document.querySelectorAll('#class-boxes input.cls-radio').forEach(r => { r.checked = false; });
        input.checked = true;
      }
      renderCards();
      updateUrlFromUI();
    });
  }

  // Hide self-only toggle
  const selfBtn = document.getElementById('hide-self-btn');
  if (selfBtn) {
    selfBtn.addEventListener('click', () => {
      const active = selfBtn.classList.toggle('active');
      selfBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
      renderCards();
      updateUrlFromUI();
    });
  }

  // Stackable-only toggle
  const stackBtn = document.getElementById('stack-only-btn');
  if (stackBtn) {
    stackBtn.addEventListener('click', () => {
      const active = stackBtn.classList.toggle('active');
      stackBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
      renderCards();
      updateUrlFromUI();
    });
  }

  // Lexicon search binding
  const lsearch = document.getElementById('lex-search');
  if (lsearch) lsearch.addEventListener('input', () => { renderLexicon(); updateUrlFromUI(); });

  // Reset-all button: clears search, class, keywords, hide-self, lexicon search, closes modal, updates URL
  const resetBtn = document.getElementById('reset-all');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      const search = document.getElementById('search');
      if (search) search.value = '';
      document.querySelectorAll('#class-boxes input.cls-radio').forEach(r => { r.checked = false; });
      document.querySelectorAll('#keyword-boxes input.kw-check').forEach(c => { c.checked = false; });
      const selfBtn = document.getElementById('hide-self-btn');
      if (selfBtn) { selfBtn.classList.remove('active'); selfBtn.setAttribute('aria-pressed', 'false'); }
      const stackBtn = document.getElementById('stack-only-btn');
      if (stackBtn) { stackBtn.classList.remove('active'); stackBtn.setAttribute('aria-pressed', 'false'); }
      document.querySelectorAll('#awakening-boxes input.awk-check').forEach(c => { c.checked = false; });
      const lq = document.getElementById('lex-search');
      if (lq) lq.value = '';
      const modal = document.getElementById('modal');
      if (modal && modal.open) { modal.dataset.char = ''; modal.close(); }
      renderLexicon();
      renderCards();
      updateUrlFromUI();
    });
  }

  // (No editor needed for General tab; content is static in the file.)

  // Apply state from URL on load and when navigating history
  const initialState = readStateFromUrl();
  applyStateToUI(initialState);
  renderLexicon();
  renderCards();
  renderTierList();
  if (initialState.char) {
    // Ensure correct tab and open the requested character
    setActiveTab('characters');
    openModal(initialState.char);
  }
  window.addEventListener('popstate', () => {
    const st = readStateFromUrl();
    applyStateToUI(st);
    renderLexicon();
    renderCards();
    renderTierList();
    const modalEl = document.getElementById('modal');
    if (st.char) {
      setActiveTab('characters');
      openModal(st.char);
    } else if (modalEl && modalEl.open) {
      modalEl.dataset.char = '';
      modalEl.close();
    }
  });

    // Initial render handled above after applying URL state
  </script>
</body>
</html>
